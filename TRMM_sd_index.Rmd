---
title: "Comparison of bias correction methods for TRMM calibration with respect to extreme precipitation events over Iberian Peninsula during 1998-2010"
author: "Óscar Mirones Alonso"
output: html_notebook
abstract: In this notebook, several standard bias correction methods are made. Four main methods are computed with the biasCorrection function (scale, eqm, pqm and gpqm). Then, the index computed with observational data, TRMM non-calibrated data and TRMM-calibrated are compared.Observation/TRMM/Corrected density functions are compared on the same graph to see the effect of the correction. Also these data are shown in QQplots. The goal is to check the improvement in the index calculation after the bias correction. This methodology is done in four different stations among the Iberian Peninsula (Madrid-Barajas, Málaga, Palma de Mallorca, San Sebastián-Igueldo). (Navacerrada and Santiago de Compostela stations have been added.)
---




```{r eval=TRUE,  message=FALSE}
library(loadeR)
library(transformeR)
library(downscaleR)
library(visualizeR)
library(climate4R.value)
library(evd)
library(formattable) #neccessary to create tables with colors
library(lubridate) #neccessary to calculate differences in years between dates
```
Load the VALUE package to obtain observational data


```{r eval=TRUE, message=FALSE}
library(VALUE)

value.dataset <- file.path(find.package("VALUE"), "example_datasets", "VALUE_ECA_86_v2.zip")

obs <- loadStationData(dataset = value.dataset, var = "precip", tz = "GMT",
                              lonLim = c(-10,4.5),
                              latLim = c(34.7,44),
                                )
```
Year subsetting of observational data.

```{r}
obs <- subsetGrid(obs, years = 1998:2010)
temporalPlot(obs, xyplot.custom = list(main = "Precipitation", ylab = "mm"))
```
Loading the .ncml file corresponding to TRMM daily data.

```{r}
setwd("C:/Users/usuario/Desktop/TRMM_3B42_Daily_V7")
inventory <- dataInventory("inventory.ncml")

```
TRMM year,longitude and latitude subsetting.

```{r}
trmm <- loadGridData(dataset = "C:/Users/usuario/Desktop/TRMM_3B42_Daily_V7/inventory.ncml",
             var = "precipitation",
             lonLim = c(-10,4.5),
             latLim = c(34.7,44) ,
             years = 1998:2010)

temporalPlot(trmm, xyplot.custom = list(main = "Precipitation", ylab = "mm"))

```
Comparision of both time series

```{r}
temporalPlot(trmm,obs, xyplot.custom = list(main = "Precipitation", ylab = "mm"))

```
The next function provides us to calculute the 13 year maximum return value. Since our temporal range is 13 years, insted of compute RV20_max index presented in Value, we compute RV13_max index using the mentioned function.

```{r}
MaxReturnValue <- function(data){
  #library(lubridate)
  nyears <- round(time_length(difftime(cal.madrid.eqm$Dates$end[length(cal.madrid.eqm$Dates$end)], cal.madrid.eqm$Dates$start[1]),"years"))
  data.maxYear <- aggregateGrid(redim(data), aggr.y = list(FUN = "max",na.rm = TRUE))

  data.maxrv <- climatology(data, clim.fun = list(FUN = "mean", na.rm = T))

  auxData <- data.maxYear$Data
  auxData[which(is.infinite(auxData))] <- NA

  if (any(!is.na(auxData))){
      auxGEV <- fgev(auxData)
      if ((auxGEV$estimate[3] - auxGEV$std.err[3] < 0) & (0  < auxGEV$estimate[3] + auxGEV$std.err[3])){
        auxGEV <- fgev(auxData, shape = 0)
        auxRV <- qgev(1-1/nyears, loc = auxGEV$estimate[1], scale = auxGEV$estimate[2], shape = 0)
      }else{
        auxRV <- qgev(1-1/nyears, loc = auxGEV$estimate[1], scale = auxGEV$estimate[2], shape = auxGEV$estimate[3])
      }
      data.maxrv <- as.numeric(auxRV)
      names(data.maxrv) <- paste("RV",nyears,"_max", sep = "")
  }
  return(data.maxrv)
  }
```



Now, for each of the four stations mentioned above, several extreme precipitation event index are computed and compared, looking for what method best approximates them.

# MADRID-BARAJAS

The index from observational and TRMM data are computed using climate4R.value function valueIndex1D. The index of interest are: Skewness, relative frequency of days with precipitation >= 10 mm (R10), precipitation amount falling in days with precip >= 10mm (R10p),relative frequency of days with precipitation >= 20 mm (R20), precipitation amount falling in days with precip >= 20mm (R20p),
 98-th percentile of wet days,i.e precipitation >= 1 mm, (P98Wet),total amount above 98-th percentile of wet days (P98WetAmount) and 13 years Max Return Value (RV13_max).
```{r}
obs.madrid <- subsetGrid(obs, station.id = obs$Metadata$station_id[11])
idx <- which.min(abs(trmm$xyCoords$x - obs.madrid$xyCoords$x))
 
lon <- trmm$xyCoords$x[idx]
  
idx2 <- which.min(abs(trmm$xyCoords$y - obs.madrid$xyCoords$y))
lat <- trmm$xyCoords$y[idx2]
  
trmm.madrid <- subsetGrid(trmm, lonLim = lon, latLim = lat)

```

First, index corresponding to observational and TRMM are calculated below.

```{r eval = TRUE, message = FALSE}
index.obs.madrid <- valueIndex1D(obs.madrid$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.obs.madrid.rv13max <- MaxReturnValue(obs.madrid)
index.trmm.madrid <- valueIndex1D(trmm.madrid$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.madrid.rv13max <- MaxReturnValue(trmm.madrid)
```
A scaling bias correction is made with leave one year out as crossvalidation. Once made this correction, the calibrated TRMM index are computed.

```{r eval=TRUE,  message=FALSE}
cal.madrid.scaling <- biasCorrection(y = obs.madrid, x = trmm.madrid, newdata = trmm.madrid, precipitation = TRUE, cross.val = "loo", method = "scaling", scaling.type = "multiplicative")

cal.madrid.scaling$Dates$start <- as.POSIXct(cal.madrid.scaling$Dates$start,tz = "GMT")
cal.madrid.scaling$Dates$end <- as.POSIXct(cal.madrid.scaling$Dates$end,tz = "GMT")


index.cal.madrid.scaling <- valueIndex1D(cal.madrid.scaling$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.madrid.scaling.rv13max <- MaxReturnValue(cal.madrid.scaling)
```


This step is analogue to previous one, in this case the bias correction method is EQM.
```{r eval=TRUE,  message=FALSE}
cal.madrid.eqm <- biasCorrection(y = obs.madrid, x = trmm.madrid, newdata = trmm.madrid, precipitation = TRUE, cross.val = "loo", method = "eqm")

cal.madrid.eqm$Dates$start <- as.POSIXct(cal.madrid.eqm$Dates$start,tz = "GMT")
cal.madrid.eqm$Dates$end <- as.POSIXct(cal.madrid.eqm$Dates$end,tz = "GMT")
```



Index are computed from the EQM-calibrated TRMM data.
```{r eval=TRUE, message=FALSE}
index.cal.madrid.eqm <- valueIndex1D(cal.madrid.eqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

index.cal.madrid.eqm.rv13max <- MaxReturnValue(cal.madrid.eqm)
```

```{r eval=TRUE, message=FALSE}
cal.madrid.eqm.extrapol <- biasCorrection(y = obs.madrid, x = trmm.madrid, newdata = trmm.madrid, precipitation = TRUE, cross.val = "loo", method = "eqm", extrapolation = "constant")

cal.madrid.eqm.extrapol$Dates$start <- as.POSIXct(cal.madrid.eqm.extrapol$Dates$start,tz = "GMT")
cal.madrid.eqm.extrapol$Dates$end <- as.POSIXct(cal.madrid.eqm.extrapol$Dates$end,tz = "GMT")
```

```{r}
index.cal.madrid.eqm.extrapol <- valueIndex1D(cal.madrid.eqm.extrapol$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

index.cal.madrid.eqm.extrapol.rv13max <- MaxReturnValue(cal.madrid.eqm.extrapol)
```

Finally, these steps are repeated using PQM and GPQM as calibration methods.
```{r eval=TRUE,  message=FALSE}
cal.madrid.pqm <- biasCorrection(y = obs.madrid, x = trmm.madrid, newdata = trmm.madrid, precipitation = TRUE, cross.val = "loo", method = "pqm",  fitdistr.args = list(densfun = "gamma"))

cal.madrid.pqm$Dates$start <- as.POSIXct(cal.madrid.pqm$Dates$start,tz = "GMT")
cal.madrid.pqm$Dates$end <- as.POSIXct(cal.madrid.pqm$Dates$end,tz = "GMT")

index.cal.madrid.pqm <- valueIndex1D(cal.madrid.pqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

index.cal.madrid.pqm.rv13max <- MaxReturnValue(cal.madrid.pqm)
```

```{r eval=TRUE, message=FALSE}
cal.madrid.gpqm <- biasCorrection(y = obs.madrid, x = trmm.madrid, newdata = trmm.madrid, precipitation = TRUE, cross.val = "loo", method = "gpqm",  theta = .70)

cal.madrid.gpqm$Dates$start <- as.POSIXct(cal.madrid.gpqm$Dates$start,tz = "GMT")
cal.madrid.gpqm$Dates$end <- as.POSIXct(cal.madrid.gpqm$Dates$end,tz = "GMT")

index.cal.madrid.gpqm <- valueIndex1D(cal.madrid.gpqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

index.cal.madrid.gpqm.rv13max <- MaxReturnValue(cal.madrid.gpqm)
```

The results is shown in dataframe format to compare which correction is closer to the observational data.
```{r}

index.obs.madrid <- c(index.obs.madrid,index.obs.madrid.rv13max)
index.trmm.madrid <- c(index.trmm.madrid,index.trmm.madrid.rv13max)
index.cal.madrid.scaling <- c(index.cal.madrid.scaling,index.cal.madrid.scaling.rv13max)
index.cal.madrid.eqm <- c(index.cal.madrid.eqm,index.cal.madrid.eqm.rv13max)
index.cal.madrid.eqm.extrapol <- c(index.cal.madrid.eqm.extrapol,index.cal.madrid.eqm.extrapol.rv13max)
index.cal.madrid.pqm <- c(index.cal.madrid.pqm,index.cal.madrid.pqm.rv13max)
index.cal.madrid.gpqm <- c(index.cal.madrid.gpqm,index.cal.madrid.gpqm.rv13max)


results.madrid <- data.frame(index.obs.madrid, index.trmm.madrid, index.cal.madrid.scaling,
                      index.cal.madrid.eqm,index.cal.madrid.eqm.extrapol, index.cal.madrid.pqm, index.cal.madrid.gpqm
                      )
colnames(results.madrid) <- c("Obs","TRMM","Scaling_cal", "EQM_cal","EQM_cal.Extrapol", "PQM_cal","GPQM_cal")

format(results.madrid, digits = 3, scientific = 5)

results.madrid
```
Also, the difference in absolute value between observational data and calibration data is presented in another dataframe. TRMM differences are also included.
```{r}
 diff.madrid <- data.frame(abs(index.trmm.madrid-index.obs.madrid),abs(index.cal.madrid.scaling-index.obs.madrid),
                      abs(index.cal.madrid.eqm-index.obs.madrid), abs(index.cal.madrid.eqm.extrapol-index.obs.madrid), abs(index.cal.madrid.pqm-index.obs.madrid), abs(index.cal.madrid.gpqm-index.obs.madrid)
                      )
colnames(diff.madrid) <- c("TRMM","Scaling_cal", "EQM_cal","EQM_cal.Extrapol", "PQM_cal.","GPQM_cal")

format(diff.madrid, digits = 3, scientific = 5)

diff.madrid
```
If we want to know, where the observations are overestimated or underestimated, with the next table we can clearly check it. Blue designates underestimation, while red designates overestimation.
```{r}
 diff.madrid.noabs <- data.frame(index.trmm.madrid-index.obs.madrid,index.cal.madrid.scaling-index.obs.madrid,
                      index.cal.madrid.eqm-index.obs.madrid, index.cal.madrid.eqm.extrapol-index.obs.madrid, index.cal.madrid.pqm-index.obs.madrid, index.cal.madrid.gpqm-index.obs.madrid)
colnames(diff.madrid.noabs) <- c("TRMM","Scaling_cal", "EQM_cal","EQM_cal.Extrapol", "PQM_cal","GPQM_cal")

#options("scipen"=100, "digits"=4)

formattable(diff.madrid.noabs, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Scaling_cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Scaling_cal > 0,"red",
                                                  ifelse(Scaling_cal == 0,"black",
                                                         ifelse(Scaling_cal <0, "blue",NA))))),
  
   'EQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(EQM_cal > 0,"red",
                                                  ifelse(EQM_cal == 0,"black",
                                                         ifelse(EQM_cal <0, "blue",NA))))),
   'EQM_cal.Extrapol' = formatter("span",
                         style = ~style(font.weight = "bold", color =
                                           ifelse(EQM_cal.Extrapol > 0,"red",
                                                  ifelse(EQM_cal.Extrapol == 0,"black",
                                                         ifelse(EQM_cal.Extrapol <0, "blue",NA))))),
   'PQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(PQM_cal > 0,"red",
                                                  ifelse(PQM_cal == 0,"black",
                                                         ifelse(PQM_cal <0, "blue",NA))))),
   'GPQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(GPQM_cal > 0,"red",
                                                  ifelse(GPQM_cal == 0,"black",
                                                         ifelse(GPQM_cal <0, "blue",NA)))))
 ))


```


Finally, the density functions and QQPlots for observational data, TRMM and each correction method is computed. This comparison can help visually to check the effect of the correction of the satellite data.

```{r}
plot(density(obs.madrid$Data, na.rm = TRUE),
main = "Obs, TRMM and Scaling cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.madrid$Data, na.rm = TRUE), col = "red")
lines(density(cal.madrid.scaling$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "Scaling calibration"), pch ='-', col = c("black", "red", "blue"))
```

```{r}
qqplot(obs.madrid$Data, trmm.madrid$Data, main = "Obs,TRMM and Scaling calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.madrid$Data), sort(cal.madrid.scaling$Data), col = "blue")

legend("topleft", legend = c("TRMM", "Scaling calibration"), pch = 1, col = c("red", "blue"))
```


```{r}
plot(density(obs.madrid$Data, na.rm = TRUE),
main = "Obs, TRMM and EQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.madrid$Data, na.rm = TRUE), col = "red")
lines(density(cal.madrid.eqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "EQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.madrid$Data, trmm.madrid$Data, main = "Obs,TRMM and EQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.madrid$Data), sort(cal.madrid.eqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "EQM calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.madrid$Data, na.rm = TRUE),
main = "Obs, TRMM and EQM extrapol cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.madrid$Data, na.rm = TRUE), col = "red")
lines(density(cal.madrid.eqm.extrapol$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "EQM extrapol calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.madrid$Data, trmm.madrid$Data, main = "Obs,TRMM and EQM extrapol calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.madrid$Data), sort(cal.madrid.eqm.extrapol$Data), col = "blue")

legend("topleft", legend = c("TRMM", "EQM extrapol calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.madrid$Data, na.rm = TRUE),
main = "Obs, TRMM and PQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.madrid$Data, na.rm = TRUE), col = "red")
lines(density(cal.madrid.pqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "PQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.madrid$Data, trmm.madrid$Data, main = "Obs,TRMM and PQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.madrid$Data), sort(cal.madrid.pqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "PQM calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.madrid$Data, na.rm = TRUE),
main = "Obs, TRMM and GPQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.madrid$Data, na.rm = TRUE), col = "red")
lines(density(cal.madrid.gpqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "GPQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.madrid$Data, trmm.madrid$Data, main = "Obs,TRMM and GPQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.madrid$Data), sort(cal.madrid.gpqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "GPQM calibration"), pch = 1, col = c("red", "blue"))
```
We can note that, in general, EQM is the best approach for the calibration in Madrid-Barajas station. The least differences with the observation data are principally with EQM calibration. In particular in Skewness, R10, R20 and R20p. The difference are really small, and this shows than a calibration with EQM in this case can improve the quality of the data. The best approach in R10p index is made with PQM. Finally, for P98Wet and P98WetAmount indices the best correction is made with GPQM, although the values corrected are quite similar to the obtained with EQM. 

Before analyzing another station, let check the density function of Observational, TRMM and TRMM calibrated data. The aim is to check that TRMM calibrated density function approximates well the observational density function. In the other side, we also show that TRMM raw density funciton is a worse approximation.

This steps are repeated in several stations of our selection.

# MÁLAGA

In this cell, some steps are taken:

* Subset observational data for the required station 
* Subset TRMM data for the required station
* Observational and TRMM index are computed
* For each calibration method, a dataset calibrated and the index of study are obtained.

```{r eval=TRUE,  message=FALSE}
obs.malaga <- subsetGrid(obs, station.id = obs$Metadata$station_id[4])
idx <- which.min(abs(trmm$xyCoords$x - obs.malaga$xyCoords$x))
lon <- trmm$xyCoords$x[idx]
  
idx2 <- which.min(abs(trmm$xyCoords$y - obs.malaga$xyCoords$y))
lat <- trmm$xyCoords$y[idx2]
  
trmm.malaga <- subsetGrid(trmm, lonLim = lon, latLim = lat)

index.obs.malaga <- valueIndex1D(obs.malaga$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

index.trmm.malaga <- valueIndex1D(trmm.malaga$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

index.obs.malaga.rv13max <- MaxReturnValue(obs.malaga)

index.trmm.malaga.rv13max <- MaxReturnValue(trmm.malaga)

cal.malaga.scaling <- biasCorrection(y = obs.malaga, x = trmm.malaga, newdata = trmm.malaga, precipitation = TRUE, cross.val = "loo", method = "scaling", scaling.type = "multiplicative")

cal.malaga.scaling$Dates$start <- as.POSIXct(cal.malaga.scaling$Dates$start,tz = "GMT")
cal.malaga.scaling$Dates$end <- as.POSIXct(cal.malaga.scaling$Dates$end,tz = "GMT")

index.malaga.scaling.rv13max <- MaxReturnValue(cal.malaga.scaling)


index.cal.malaga.scaling <- valueIndex1D(cal.malaga.scaling$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.malaga.eqm <- biasCorrection(y = obs.malaga, x = trmm.malaga, newdata = trmm.malaga, precipitation = TRUE, cross.val = "loo", method = "eqm")

cal.malaga.eqm$Dates$start <- as.POSIXct(cal.malaga.eqm$Dates$start,tz = "GMT")
cal.malaga.eqm$Dates$end <- as.POSIXct(cal.malaga.eqm$Dates$end,tz = "GMT")

index.cal.malaga.eqm.rv13max <- MaxReturnValue(cal.malaga.eqm)


index.cal.malaga.eqm <- valueIndex1D(cal.malaga.eqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.malaga.eqm.extrapol <- biasCorrection(y = obs.malaga, x = trmm.malaga, newdata = trmm.malaga, precipitation = TRUE, cross.val = "loo", method = "eqm",extrapolation = "constant")

cal.malaga.eqm.extrapol$Dates$start <- as.POSIXct(cal.malaga.eqm.extrapol$Dates$start,tz = "GMT")
cal.malaga.eqm.extrapol$Dates$end <- as.POSIXct(cal.malaga.eqm.extrapol$Dates$end,tz = "GMT")

index.cal.malaga.eqm.extrapol.rv13max <- MaxReturnValue(cal.malaga.eqm.extrapol)


index.cal.malaga.eqm.extrapol <- valueIndex1D(cal.malaga.eqm.extrapol$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.malaga.pqm <- biasCorrection(y = obs.malaga, x = trmm.malaga, newdata = trmm.malaga, precipitation = TRUE, cross.val = "loo", method = "pqm",  fitdistr.args = list(densfun = "gamma"))

cal.malaga.pqm$Dates$start <- as.POSIXct(cal.malaga.pqm$Dates$start,tz = "GMT")
cal.malaga.pqm$Dates$end <- as.POSIXct(cal.malaga.pqm$Dates$end,tz = "GMT")

index.cal.malaga.pqm.rv13max <- MaxReturnValue(cal.malaga.pqm)

index.cal.malaga.pqm <- valueIndex1D(cal.malaga.pqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.malaga.gpqm <- biasCorrection(y = obs.malaga, x = trmm.malaga, newdata = trmm.malaga, precipitation = TRUE, cross.val = "loo", method = "gpqm", theta = 0.7)

cal.malaga.gpqm$Dates$start <- as.POSIXct(cal.malaga.gpqm$Dates$start,tz = "GMT")
cal.malaga.gpqm$Dates$end <- as.POSIXct(cal.malaga.gpqm$Dates$end,tz = "GMT")

index.cal.malaga.gpqm.rv13max <- MaxReturnValue(cal.malaga.gpqm)

index.cal.malaga.gpqm <- valueIndex1D(cal.malaga.gpqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
```

Showing Málaga station results 

```{r}

index.obs.malaga <- c(index.obs.malaga,index.obs.malaga.rv13max)
index.trmm.malaga <- c(index.trmm.malaga,index.trmm.malaga.rv13max)
index.cal.malaga.scaling <- c(index.cal.malaga.scaling,index.malaga.scaling.rv13max)
index.cal.malaga.eqm <- c(index.cal.malaga.eqm,index.cal.malaga.eqm.rv13max)
index.cal.malaga.eqm.extrapol <- c(index.cal.malaga.eqm.extrapol,index.cal.malaga.eqm.extrapol.rv13max)
index.cal.malaga.pqm <- c(index.cal.malaga.pqm,index.cal.malaga.pqm.rv13max)
index.cal.malaga.gpqm <- c(index.cal.malaga.gpqm,index.cal.malaga.gpqm.rv13max)

results.malaga <- data.frame(index.obs.malaga, index.trmm.malaga, index.cal.malaga.scaling,
                      index.cal.malaga.eqm,index.cal.malaga.eqm.extrapol, index.cal.malaga.pqm, index.cal.malaga.gpqm
                      )

colnames(results.malaga) <- c("Obs","TRMM","Scaling cal.", "EQM cal.", "EQM extrapol cal.","PQM cal.","GPQM cal.")

results.malaga <- format(results.malaga, digits = 3, scientific = 5)

results.malaga
```
```{r}
 diff.malaga <- data.frame(abs(index.trmm.malaga-index.obs.malaga),abs(index.cal.malaga.scaling-index.obs.malaga),
                      abs(index.cal.malaga.eqm-index.obs.malaga),abs(index.cal.malaga.eqm.extrapol-index.obs.malaga), abs(index.cal.malaga.pqm-index.obs.malaga), abs(index.cal.malaga.gpqm-index.obs.malaga)
                      )
colnames(diff.malaga) <- c("TRMM","Scaling cal.", "EQM cal.","EQM extrapol cal.", "PQM cal.","GPQM cal.")

diff.malaga <- format(diff.malaga, digits = 3, scientific = 5)

diff.malaga
```
```{r}
 diff.malaga.noabs <- data.frame(index.trmm.malaga-index.obs.malaga,index.cal.malaga.scaling-index.obs.malaga,
                      index.cal.malaga.eqm-index.obs.malaga,index.cal.malaga.eqm.extrapol-index.obs.malaga, index.cal.malaga.pqm-index.obs.malaga, index.cal.malaga.gpqm-index.obs.malaga)
colnames(diff.malaga.noabs) <- c("TRMM","Scaling_cal", "EQM_cal","EQM_cal.Extrapol", "PQM_cal","GPQM_cal")



formattable(diff.malaga.noabs, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Scaling_cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Scaling_cal > 0,"red",
                                                  ifelse(Scaling_cal == 0,"black",
                                                         ifelse(Scaling_cal <0, "blue",NA))))),
  
   'EQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(EQM_cal > 0,"red",
                                                  ifelse(EQM_cal == 0,"black",
                                                         ifelse(EQM_cal <0, "blue",NA))))),
   'EQM_cal.Extrapol' = formatter("span",
                         style = ~style(font.weight = "bold", color =
                                           ifelse(EQM_cal.Extrapol > 0,"red",
                                                  ifelse(EQM_cal.Extrapol == 0,"black",
                                                         ifelse(EQM_cal.Extrapol <0, "blue",NA))))),
   'PQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(PQM_cal > 0,"red",
                                                  ifelse(PQM_cal == 0,"black",
                                                         ifelse(PQM_cal <0, "blue",NA))))),
   'GPQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(GPQM_cal > 0,"red",
                                                  ifelse(GPQM_cal == 0,"black",
                                                         ifelse(GPQM_cal <0, "blue",NA)))))
 ))
```

Here we have a greater variety in terms of indices that work better in the correction. PQM is the best option for R10, R20p and P98WetAmount. EQm with extrapolation has the best results in Skewness approximation, as scaling is the best choice for R20 index. Finally, surprisingly TRMM in some indices has the best approximation. R10p and P98Wet are these indices. 

```{r}
plot(density(obs.malaga$Data, na.rm = TRUE),
main = "Obs, TRMM and Scaling cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.malaga$Data, na.rm = TRUE), col = "red")
lines(density(cal.malaga.scaling$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "Scaling calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.malaga$Data, trmm.malaga$Data, main = "Obs,TRMM and Scaling calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col ="red")

abline(a = 0, b = 1)

points(sort(obs.malaga$Data), sort(cal.malaga.scaling$Data), col = "blue")

legend("topleft", legend = c("TRMM", "Scaling calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.malaga$Data, na.rm = TRUE),
main = "Obs, TRMM and EQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.malaga$Data, na.rm = TRUE), col = "red")
lines(density(cal.malaga.eqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "EQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.malaga$Data, trmm.malaga$Data, main = "Obs,TRMM and EQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.malaga$Data), sort(cal.malaga.eqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "EQM calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.malaga$Data, na.rm = TRUE),
main = "Obs, TRMM and EQM extrapol cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.malaga$Data, na.rm = TRUE), col = "red")
lines(density(cal.malaga.eqm.extrapol$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "EQM extrapol calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.malaga$Data, trmm.malaga$Data, main = "Obs,TRMM and EQM extrapol calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.malaga$Data), sort(cal.malaga.eqm.extrapol$Data), col = "blue")

legend("topleft", legend = c("TRMM", "EQM extrapol calibration"), pch = 1, col = c("red", "blue"))
```


```{r}
plot(density(obs.malaga$Data, na.rm = TRUE),
main = "Obs, TRMM and PQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.malaga$Data, na.rm = TRUE), col = "red")
lines(density(cal.malaga.pqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "PQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.malaga$Data, trmm.malaga$Data, main = "Obs,TRMM and PQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.malaga$Data), sort(cal.malaga.pqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "PQM calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.malaga$Data, na.rm = TRUE),
main = "Obs, TRMM and GPQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.malaga$Data, na.rm = TRUE), col = "red")
lines(density(cal.malaga.gpqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "GPQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.malaga$Data, trmm.malaga$Data, main = "Obs,TRMM and GPQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.malaga$Data), sort(cal.malaga.gpqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "GPQM calibration"), pch = 1, col = c("red", "blue"))
```

# PALMA DE MALLORCA

Methodology is the same, but the station to study is Palma de Mallorca
```{r eval=TRUE,  message=FALSE}
obs.mallorca <- subsetGrid(obs, station.id = obs$Metadata$station_id[10])
idx <- which.min(abs(trmm$xyCoords$x - obs.mallorca$xyCoords$x))
lon <- trmm$xyCoords$x[idx]
  
idx2 <- which.min(abs(trmm$xyCoords$y - obs.mallorca$xyCoords$y))
lat <- trmm$xyCoords$y[idx2]
  
trmm.mallorca <- subsetGrid(trmm, lonLim = lon, latLim = lat)

index.obs.mallorca <- valueIndex1D(obs.mallorca$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

index.trmm.mallorca <- valueIndex1D(trmm.mallorca$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

index.obs.mallorca.rv13max <- MaxReturnValue(obs.mallorca)

index.trmm.mallorca.rv13max <- MaxReturnValue(trmm.mallorca)

cal.mallorca.scaling <- biasCorrection(y = obs.mallorca, x = trmm.mallorca, newdata = trmm.mallorca, precipitation = TRUE, cross.val = "loo", method = "scaling", scaling.type = "multiplicative")

cal.mallorca.scaling$Dates$start <- as.POSIXct(cal.mallorca.scaling$Dates$start,tz = "GMT")
cal.mallorca.scaling$Dates$end <- as.POSIXct(cal.mallorca.scaling$Dates$end,tz = "GMT")

index.cal.mallorca.scaling.rv13max <- MaxReturnValue(cal.mallorca.scaling)

index.cal.mallorca.scaling <- valueIndex1D(cal.mallorca.scaling$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.mallorca.eqm <- biasCorrection(y = obs.mallorca, x = trmm.mallorca, newdata = trmm.mallorca, precipitation = TRUE, cross.val = "loo", method = "eqm")

cal.mallorca.eqm$Dates$start <- as.POSIXct(cal.mallorca.eqm$Dates$start,tz = "GMT")
cal.mallorca.eqm$Dates$end <- as.POSIXct(cal.mallorca.eqm$Dates$end,tz = "GMT")

index.cal.mallorca.eqm.rv13max <- MaxReturnValue(cal.mallorca.eqm)


index.cal.mallorca.eqm <- valueIndex1D(cal.mallorca.eqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.mallorca.eqm.extrapol <- biasCorrection(y = obs.mallorca, x = trmm.mallorca, newdata = trmm.mallorca, precipitation = TRUE, cross.val = "loo", method = "eqm", extrapolation = "constant")

cal.mallorca.eqm.extrapol$Dates$start <- as.POSIXct(cal.mallorca.eqm.extrapol$Dates$start,tz = "GMT")
cal.mallorca.eqm.extrapol$Dates$end <- as.POSIXct(cal.mallorca.eqm.extrapol$Dates$end,tz = "GMT")

index.cal.mallorca.eqm.extrapol.rv13max <- MaxReturnValue(cal.mallorca.eqm.extrapol)


index.cal.mallorca.eqm.extrapol <- valueIndex1D(cal.mallorca.eqm.extrapol$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.mallorca.pqm <- biasCorrection(y = obs.mallorca, x = trmm.mallorca, newdata = trmm.mallorca, precipitation = TRUE, cross.val = "loo", method = "pqm",  fitdistr.args = list(densfun = "gamma"))

cal.mallorca.pqm$Dates$start <- as.POSIXct(cal.mallorca.pqm$Dates$start,tz = "GMT")
cal.mallorca.pqm$Dates$end <- as.POSIXct(cal.mallorca.pqm$Dates$end,tz = "GMT")

index.cal.mallorca.pqm.rv13max <- MaxReturnValue(cal.mallorca.pqm)

index.cal.mallorca.pqm <- valueIndex1D(cal.mallorca.pqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.mallorca.gpqm <- biasCorrection(y = obs.mallorca, x = trmm.mallorca, newdata = trmm.mallorca, precipitation = TRUE, cross.val = "loo", method = "gpqm", theta = 0.7)

cal.mallorca.gpqm$Dates$start <- as.POSIXct(cal.mallorca.gpqm$Dates$start,tz = "GMT")
cal.mallorca.gpqm$Dates$end <- as.POSIXct(cal.mallorca.gpqm$Dates$end,tz = "GMT")

index.cal.mallorca.gpqm.rv13max <- MaxReturnValue(cal.mallorca.gpqm)

index.cal.mallorca.gpqm <- valueIndex1D(cal.mallorca.gpqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
```


```{r}

index.obs.mallorca <- c(index.obs.mallorca,index.obs.mallorca.rv13max)
index.trmm.mallorca <- c(index.trmm.mallorca,index.trmm.mallorca.rv13max)
index.cal.mallorca.scaling <- c(index.cal.mallorca.scaling,index.cal.mallorca.scaling.rv13max)
index.cal.mallorca.eqm <- c(index.cal.mallorca.eqm,index.cal.mallorca.eqm.rv13max)
index.cal.mallorca.eqm.extrapol <- c(index.cal.mallorca.eqm.extrapol,index.cal.mallorca.eqm.extrapol.rv13max)
index.cal.mallorca.pqm <- c(index.cal.mallorca.pqm,index.cal.mallorca.pqm.rv13max)
index.cal.mallorca.gpqm <- c(index.cal.mallorca.gpqm,index.cal.mallorca.gpqm.rv13max)

results.mallorca <- data.frame(index.obs.mallorca, index.trmm.mallorca,index.cal.mallorca.scaling,
                      index.cal.mallorca.eqm, index.cal.mallorca.eqm.extrapol ,index.cal.mallorca.pqm, index.cal.mallorca.gpqm
                      )
colnames(results.mallorca) <- c("Obs","TRMM","Scaling cal.", "EQM cal.","EQM extrapol cal", "PQM cal.","GPQM cal.")

results.mallorca <- format(results.mallorca, digits = 3, scientific = 5)

results.mallorca
```
```{r}
 diff.mallorca <- data.frame(abs(index.trmm.mallorca-index.obs.mallorca),abs(index.cal.mallorca.scaling-index.obs.mallorca),
                      abs(index.cal.mallorca.eqm-index.obs.mallorca),abs(index.cal.mallorca.eqm.extrapol-index.obs.mallorca), abs(index.cal.mallorca.pqm-index.obs.mallorca), abs(index.cal.mallorca.gpqm-index.obs.mallorca)
                      )
colnames(diff.mallorca) <- c("TRMM","Scaling cal.", "EQM cal.", "EQM extrapol cal.", "PQM cal.","GPQM cal.")

diff.mallorca <- format(diff.mallorca, digits = 3, scientific = 5)


diff.mallorca
```
```{r}
 diff.mallorca.noabs <- data.frame(index.trmm.mallorca-index.obs.mallorca,index.cal.mallorca.scaling-index.obs.mallorca,
                      index.cal.mallorca.eqm-index.obs.mallorca, index.cal.mallorca.eqm.extrapol-index.obs.mallorca, index.cal.mallorca.pqm-index.obs.mallorca, index.cal.mallorca.gpqm-index.obs.mallorca)
colnames(diff.mallorca.noabs) <- c("TRMM","Scaling_cal", "EQM_cal","EQM_cal.Extrapol", "PQM_cal","GPQM_cal")



formattable(diff.mallorca.noabs, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Scaling_cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Scaling_cal > 0,"red",
                                                  ifelse(Scaling_cal == 0,"black",
                                                         ifelse(Scaling_cal <0, "blue",NA))))),
  
   'EQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(EQM_cal > 0,"red",
                                                  ifelse(EQM_cal == 0,"black",
                                                         ifelse(EQM_cal <0, "blue",NA))))),
   'EQM_cal.Extrapol' = formatter("span",
                         style = ~style(font.weight = "bold", color =
                                           ifelse(EQM_cal.Extrapol > 0,"red",
                                                  ifelse(EQM_cal.Extrapol == 0,"black",
                                                         ifelse(EQM_cal.Extrapol <0, "blue",NA))))),
   'PQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(PQM_cal > 0,"red",
                                                  ifelse(PQM_cal == 0,"black",
                                                         ifelse(PQM_cal <0, "blue",NA))))),
   'GPQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(GPQM_cal > 0,"red",
                                                  ifelse(GPQM_cal == 0,"black",
                                                         ifelse(GPQM_cal <0, "blue",NA)))))
 ))
```


```{r}
plot(density(obs.mallorca$Data, na.rm = TRUE),
main = "Obs, TRMM and Scaling cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.mallorca$Data, na.rm = TRUE), col = "red")
lines(density(cal.mallorca.scaling$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "Scaling calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.mallorca$Data, trmm.mallorca$Data, main = "Obs,TRMM and Scaling calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.mallorca$Data), sort(cal.mallorca.scaling$Data), col = "blue")

legend("topleft", legend = c("TRMM", "Scaling calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.mallorca$Data, na.rm = TRUE),
main = "Obs, TRMM and EQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.mallorca$Data, na.rm = TRUE), col = "red")
lines(density(cal.mallorca.eqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "EQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.mallorca$Data, trmm.mallorca$Data, main = "Obs,TRMM and EQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.mallorca$Data), sort(cal.mallorca.eqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "EQM calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.mallorca$Data, na.rm = TRUE),
main = "Obs, TRMM and EQM extrapol cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.mallorca$Data, na.rm = TRUE), col = "red")
lines(density(cal.mallorca.eqm.extrapol$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "EQM extrapol calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.mallorca$Data, trmm.mallorca$Data, main = "Obs,TRMM and EQM extrapol calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.mallorca$Data), sort(cal.mallorca.eqm.extrapol$Data), col = "blue")

legend("topleft", legend = c("TRMM", "EQM extrapol calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.mallorca$Data, na.rm = TRUE),
main = "Obs, TRMM and PQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.mallorca$Data, na.rm = TRUE), col = "red")
lines(density(cal.mallorca.pqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "PQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.mallorca$Data, trmm.mallorca$Data, main = "Obs,TRMM and PQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.mallorca$Data), sort(cal.mallorca.pqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "PQM calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.mallorca$Data, na.rm = TRUE),
main = "Obs, TRMM and GPQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.mallorca$Data, na.rm = TRUE), col = "red")
lines(density(cal.mallorca.gpqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "GPQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.mallorca$Data, trmm.mallorca$Data, main = "Obs,TRMM and GPQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.mallorca$Data), sort(cal.mallorca.gpqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "GPQM calibration"), pch = 1, col = c("red", "blue"))
```

One more time, EQM gets the best results in all of the index computed. The results are quite good, showing that the calibration matters and is necessary. The performance of the other calibration methods compared to TRMM is quite good too, with the exception of the values for P98WetAmount in general. Also, the value obtained with GPQM calibration in P98Wet Index is really poor(worse than TRMM).

# SAN SEBASTIÁN-IGUELDO

Same with San Sebastián-Igueldo station.
```{r eval=TRUE,  message=FALSE}
obs.sansebastian <- subsetGrid(obs, station.id = obs$Metadata$station_id[6])
idx <- which.min(abs(trmm$xyCoords$x - obs.sansebastian$xyCoords$x))
lon <- trmm$xyCoords$x[idx]
  
idx2 <- which.min(abs(trmm$xyCoords$y - obs.sansebastian$xyCoords$y))
lat <- trmm$xyCoords$y[idx2]
  
trmm.sansebastian <- subsetGrid(trmm, lonLim = lon, latLim = lat)

index.obs.sansebastian <- valueIndex1D(obs.sansebastian$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

index.trmm.sansebastian <- valueIndex1D(trmm.sansebastian$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

index.obs.sansebastian.rv13max <- MaxReturnValue(obs.sansebastian)
index.trmm.sansebastian.rv13max <- MaxReturnValue(trmm.sansebastian)


cal.sansebastian.scaling <- biasCorrection(y = obs.sansebastian, x = trmm.sansebastian, newdata = trmm.sansebastian, precipitation = TRUE, cross.val = "loo", method = "scaling", scaling.type = "multiplicative")

cal.sansebastian.scaling$Dates$start <- as.POSIXct(cal.sansebastian.scaling$Dates$start,tz = "GMT")
cal.sansebastian.scaling$Dates$end <- as.POSIXct(cal.sansebastian.scaling$Dates$end,tz = "GMT")

index.cal.sansebastian.scaling.rv13max <- MaxReturnValue(cal.sansebastian.scaling)


index.cal.sansebastian.scaling <- valueIndex1D(cal.sansebastian.scaling$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.sansebastian.eqm <- biasCorrection(y = obs.sansebastian, x = trmm.sansebastian, newdata = trmm.sansebastian, precipitation = TRUE, cross.val = "loo", method = "eqm")

cal.sansebastian.eqm$Dates$start <- as.POSIXct(cal.sansebastian.eqm$Dates$start,tz = "GMT")
cal.sansebastian.eqm$Dates$end <- as.POSIXct(cal.sansebastian.eqm$Dates$end,tz = "GMT")

index.cal.sansebastian.eqm.rv13max <- MaxReturnValue(cal.sansebastian.eqm)



index.cal.sansebastian.eqm <- valueIndex1D(cal.sansebastian.eqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.sansebastian.eqm.extrapol <- biasCorrection(y = obs.sansebastian, x = trmm.sansebastian, newdata = trmm.sansebastian, precipitation = TRUE, cross.val = "loo", method = "eqm", extrapolation = "constant")

cal.sansebastian.eqm.extrapol$Dates$start <- as.POSIXct(cal.sansebastian.eqm.extrapol$Dates$start,tz = "GMT")
cal.sansebastian.eqm.extrapol$Dates$end <- as.POSIXct(cal.sansebastian.eqm.extrapol$Dates$end,tz = "GMT")

index.cal.sansebastian.eqm.extrapol.rv13max <- MaxReturnValue(cal.sansebastian.eqm.extrapol)



index.cal.sansebastian.eqm.extrapol <- valueIndex1D(cal.sansebastian.eqm.extrapol$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.sansebastian.pqm <- biasCorrection(y = obs.sansebastian, x = trmm.sansebastian, newdata = trmm.sansebastian, precipitation = TRUE, cross.val = "loo", method = "pqm",  fitdistr.args = list(densfun = "gamma"))

cal.sansebastian.pqm$Dates$start <- as.POSIXct(cal.sansebastian.pqm$Dates$start,tz = "GMT")
cal.sansebastian.pqm$Dates$end <- as.POSIXct(cal.sansebastian.pqm$Dates$end,tz = "GMT")

index.cal.sansebastian.pqm.rv13max <- MaxReturnValue(cal.sansebastian.pqm)


index.cal.sansebastian.pqm <- valueIndex1D(cal.sansebastian.pqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.sansebastian.gpqm <- biasCorrection(y = obs.sansebastian, x = trmm.sansebastian, newdata = trmm.sansebastian, precipitation = TRUE, cross.val = "loo", method = "gpqm", theta = 0.7)

cal.sansebastian.gpqm$Dates$start <- as.POSIXct(cal.sansebastian.gpqm$Dates$start,tz = "GMT")
cal.sansebastian.gpqm$Dates$end <- as.POSIXct(cal.sansebastian.gpqm$Dates$end,tz = "GMT")

index.cal.sansebastian.gpqm.rv13max <- MaxReturnValue(cal.sansebastian.gpqm)



index.cal.sansebastian.gpqm <- valueIndex1D(cal.sansebastian.gpqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
```



```{r}

index.obs.sansebastian <- c(index.obs.sansebastian,index.obs.sansebastian.rv13max)
index.trmm.sansebastian <- c(index.trmm.sansebastian,index.trmm.sansebastian.rv13max)
index.cal.sansebastian.scaling <- c(index.cal.sansebastian.scaling,index.cal.sansebastian.scaling.rv13max)
index.cal.sansebastian.eqm <- c(index.cal.sansebastian.eqm,index.cal.sansebastian.eqm.rv13max)
index.cal.sansebastian.eqm.extrapol <- c(index.cal.sansebastian.eqm.extrapol,index.cal.sansebastian.eqm.extrapol.rv13max)
index.cal.sansebastian.pqm <- c(index.cal.sansebastian.pqm,index.cal.sansebastian.pqm.rv13max)
index.cal.sansebastian.gpqm <- c(index.cal.sansebastian.gpqm,index.cal.sansebastian.gpqm.rv13max)

results.sansebastian <- data.frame(index.obs.sansebastian, index.trmm.sansebastian, index.cal.sansebastian.scaling,
                      index.cal.sansebastian.eqm,index.cal.sansebastian.eqm.extrapol, index.cal.sansebastian.pqm, index.cal.sansebastian.gpqm
                      )
colnames(results.sansebastian) <- c("Obs","TRMM","Scaling cal.", "EQM cal.","EQM extrapol cal.", "PQM cal.","GPQM cal.")

results.sansebastian <- format(results.sansebastian, digits = 3, scientific = 5)

results.sansebastian

```

```{r}
 diff.sansebastian <- data.frame(abs(index.trmm.sansebastian-index.obs.sansebastian),abs(index.cal.sansebastian.scaling-index.obs.sansebastian),
                      abs(index.cal.sansebastian.eqm-index.obs.sansebastian),abs(index.cal.sansebastian.eqm.extrapol-index.obs.sansebastian), abs(index.cal.sansebastian.pqm-index.obs.sansebastian), abs(index.cal.sansebastian.gpqm-index.obs.sansebastian)
                      )
colnames(diff.sansebastian) <- c("TRMM","Scaling cal.", "EQM cal.", "EQM extrapol cal.","PQM cal.","GPQM cal.")

diff.sansebastian <- format(diff.sansebastian, digits = 3, scientific = 5)

diff.sansebastian
```
```{r}
 diff.sansebastian.noabs <- data.frame(index.trmm.sansebastian-index.obs.sansebastian,index.cal.sansebastian.scaling-index.obs.sansebastian,
                      index.cal.sansebastian.eqm-index.obs.sansebastian, index.cal.sansebastian.eqm.extrapol-index.obs.sansebastian, index.cal.sansebastian.pqm-index.obs.sansebastian, index.cal.sansebastian.gpqm-index.obs.sansebastian)
colnames(diff.sansebastian.noabs) <- c("TRMM","Scaling_cal", "EQM_cal","EQM_cal.Extrapol", "PQM_cal","GPQM_cal")


formattable(diff.sansebastian.noabs, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Scaling_cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Scaling_cal > 0,"red",
                                                  ifelse(Scaling_cal == 0,"black",
                                                         ifelse(Scaling_cal <0, "blue",NA))))),
  
   'EQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(EQM_cal > 0,"red",
                                                  ifelse(EQM_cal == 0,"black",
                                                         ifelse(EQM_cal <0, "blue",NA))))),
   'EQM_cal.Extrapol' = formatter("span",
                         style = ~style(font.weight = "bold", color =
                                           ifelse(EQM_cal.Extrapol > 0,"red",
                                                  ifelse(EQM_cal.Extrapol == 0,"black",
                                                         ifelse(EQM_cal.Extrapol <0, "blue",NA))))),
   'PQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(PQM_cal > 0,"red",
                                                  ifelse(PQM_cal == 0,"black",
                                                         ifelse(PQM_cal <0, "blue",NA))))),
   'GPQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(GPQM_cal > 0,"red",
                                                  ifelse(GPQM_cal == 0,"black",
                                                         ifelse(GPQM_cal <0, "blue",NA)))))
 ))
```

```{r}
plot(density(obs.sansebastian$Data, na.rm = TRUE),
main = "Obs, TRMM and Scaling cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.sansebastian$Data, na.rm = TRUE), col = "red")
lines(density(cal.sansebastian.scaling$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "Scaling calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.sansebastian$Data, trmm.sansebastian$Data, main = "Obs,TRMM and Scaling calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.sansebastian$Data), sort(cal.sansebastian.scaling$Data), col = "blue")

legend("topleft", legend = c("TRMM", "Scaling calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.sansebastian$Data, na.rm = TRUE),
main = "Obs, TRMM and EQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.sansebastian$Data, na.rm = TRUE), col = "red")
lines(density(cal.sansebastian.eqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "EQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.sansebastian$Data, trmm.sansebastian$Data, main = "Obs,TRMM and EQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.sansebastian$Data), sort(cal.sansebastian.eqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "EQM calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.sansebastian$Data, na.rm = TRUE),
main = "Obs, TRMM and EQM extrapol cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.sansebastian$Data, na.rm = TRUE), col = "red")
lines(density(cal.sansebastian.eqm.extrapol$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "EQM extrapol calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.sansebastian$Data, trmm.sansebastian$Data, main = "Obs,TRMM and EQM extrapol calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.sansebastian$Data), sort(cal.sansebastian.eqm.extrapol$Data), col = "blue")

legend("topleft", legend = c("TRMM", "EQM extrapol calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.sansebastian$Data, na.rm = TRUE),
main = "Obs, TRMM and PQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.sansebastian$Data, na.rm = TRUE), col = "red")
lines(density(cal.sansebastian.pqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "PQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.sansebastian$Data, trmm.sansebastian$Data, main = "Obs,TRMM and PQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.sansebastian$Data), sort(cal.sansebastian.pqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "PQM calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.sansebastian$Data, na.rm = TRUE),
main = "Obs, TRMM and GPQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.sansebastian$Data, na.rm = TRUE), col = "red")
lines(density(cal.sansebastian.gpqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "GPQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.sansebastian$Data, trmm.sansebastian$Data, main = "Obs,TRMM and GPQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.sansebastian$Data), sort(cal.sansebastian.gpqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "GPQM calibration"), pch = 1, col = c("red", "blue"))
```
In this case, EQM calibration method only is the best approach for one index, R10. GPQM calibration method gets the best results for Skewness and P98Wet indices. Unfortunately, the value for P98WetAmount is really high(+400 of TRMM value.). For the P98WetAmount index, the best approach is using scaling calibration method. EQM get a worse result than TRMM for this index. PQM improve it, however the difference with the observational data is too high(664).

We can conclude that for 3 of the 4 stations, EQM is the best approach getting great results. Calibration methods have been shown necessary for precipitation study with TRMM remote sensing. Scaling and PQM in general give good results too. It seems that the index with worse approach in this calibration is P98WetAmount. The rest of the indices with calibration methods applied have a good approximation in general.The next steps could be to look at which methods overestimate the values of observations and which underestimate them.

# EXTRA

# Navacerrada

```{r eval=TRUE,  message=FALSE}
obs.navacerrada <- subsetGrid(obs, station.id = obs$Metadata$station_id[5])
idx <- which.min(abs(trmm$xyCoords$x - obs.navacerrada$xyCoords$x))
lon <- trmm$xyCoords$x[idx]
  
idx2 <- which.min(abs(trmm$xyCoords$y - obs.navacerrada$xyCoords$y))
lat <- trmm$xyCoords$y[idx2]
  
trmm.navacerrada <- subsetGrid(trmm, lonLim = lon, latLim = lat)

index.obs.navacerrada.rv13max <- MaxReturnValue(obs.navacerrada)
index.trmm.navacerrada.rv13max <- MaxReturnValue(trmm.navacerrada)


index.obs.navacerrada <- valueIndex1D(obs.navacerrada$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

index.trmm.navacerrada <- valueIndex1D(trmm.navacerrada$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


cal.navacerrada.scaling <- biasCorrection(y = obs.navacerrada, x = trmm.navacerrada, newdata = trmm.navacerrada, precipitation = TRUE, cross.val = "loo", method = "scaling", scaling.type = "multiplicative")

cal.navacerrada.scaling$Dates$start <- as.POSIXct(cal.navacerrada.scaling$Dates$start,tz = "GMT")
cal.navacerrada.scaling$Dates$end <- as.POSIXct(cal.navacerrada.scaling$Dates$end,tz = "GMT")

index.cal.navacerrada.scaling.rv13max <- MaxReturnValue(cal.navacerrada.scaling)

index.cal.navacerrada.scaling <- valueIndex1D(cal.navacerrada.scaling$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.navacerrada.eqm <- biasCorrection(y = obs.navacerrada, x = trmm.navacerrada, newdata = trmm.navacerrada, precipitation = TRUE, cross.val = "loo", method = "eqm")

cal.navacerrada.eqm$Dates$start <- as.POSIXct(cal.navacerrada.eqm$Dates$start,tz = "GMT")
cal.navacerrada.eqm$Dates$end <- as.POSIXct(cal.navacerrada.eqm$Dates$end,tz = "GMT")

index.cal.navacerrada.eqm.rv13max <- MaxReturnValue(cal.navacerrada.eqm)


index.cal.navacerrada.eqm <- valueIndex1D(cal.navacerrada.eqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.navacerrada.eqm.extrapol <- biasCorrection(y = obs.navacerrada, x = trmm.navacerrada, newdata = trmm.navacerrada, precipitation = TRUE, cross.val = "loo", method = "eqm",extrapolation = "constant")

cal.navacerrada.eqm.extrapol$Dates$start <- as.POSIXct(cal.navacerrada.eqm.extrapol$Dates$start,tz = "GMT")
cal.navacerrada.eqm.extrapol$Dates$end <- as.POSIXct(cal.navacerrada.eqm.extrapol$Dates$end,tz = "GMT")

index.cal.navacerrada.eqm.extrapol.rv13max <- MaxReturnValue(cal.navacerrada.eqm.extrapol)

index.cal.navacerrada.eqm.extrapol <- valueIndex1D(cal.navacerrada.eqm.extrapol$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.navacerrada.pqm <- biasCorrection(y = obs.navacerrada, x = trmm.navacerrada, newdata = trmm.navacerrada, precipitation = TRUE, cross.val = "loo", method = "pqm",  fitdistr.args = list(densfun = "gamma"))

cal.navacerrada.pqm$Dates$start <- as.POSIXct(cal.navacerrada.pqm$Dates$start,tz = "GMT")
cal.navacerrada.pqm$Dates$end <- as.POSIXct(cal.navacerrada.pqm$Dates$end,tz = "GMT")

index.cal.navacerrada.pqm.rv13max <- MaxReturnValue(cal.navacerrada.pqm)

index.cal.navacerrada.pqm <- valueIndex1D(cal.navacerrada.pqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.navacerrada.gpqm <- biasCorrection(y = obs.navacerrada, x = trmm.navacerrada, newdata = trmm.navacerrada, precipitation = TRUE, cross.val = "loo", method = "gpqm", theta = 0.7)

cal.navacerrada.gpqm$Dates$start <- as.POSIXct(cal.navacerrada.gpqm$Dates$start,tz = "GMT")
cal.navacerrada.gpqm$Dates$end <- as.POSIXct(cal.navacerrada.gpqm$Dates$end,tz = "GMT")

index.cal.navacerrada.gpqm.rv13max <- MaxReturnValue(cal.navacerrada.gpqm)

index.cal.navacerrada.gpqm <- valueIndex1D(cal.navacerrada.gpqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
```

```{r}
index.obs.navacerrada <- c(index.obs.navacerrada,index.obs.navacerrada.rv13max)
index.trmm.navacerrada <- c(index.trmm.navacerrada,index.trmm.navacerrada.rv13max)
index.cal.navacerrada.scaling <- c(index.cal.navacerrada.scaling,index.cal.navacerrada.scaling.rv13max)
index.cal.navacerrada.eqm <- c(index.cal.navacerrada.eqm,index.cal.navacerrada.eqm.extrapol.rv13max)
index.cal.navacerrada.eqm.extrapol <- c(index.cal.navacerrada.eqm.extrapol,index.cal.navacerrada.eqm.extrapol.rv13max)
index.cal.navacerrada.pqm <- c(index.cal.navacerrada.pqm,index.cal.navacerrada.pqm.rv13max)
index.cal.navacerrada.gpqm <- c(index.cal.navacerrada.gpqm,index.cal.navacerrada.gpqm.rv13max)

results.navacerrada <- data.frame(index.obs.navacerrada, index.trmm.navacerrada, index.cal.navacerrada.scaling,
                      index.cal.navacerrada.eqm,index.cal.navacerrada.eqm.extrapol, index.cal.navacerrada.pqm, index.cal.navacerrada.gpqm
                      )
colnames(results.navacerrada) <- c("Obs","TRMM","Scaling cal.", "EQM cal.","EQM extrapol cal.", "PQM cal.","GPQM cal.")

results.navacerrada <- format(results.navacerrada, digits = 3, scientific = 5)

results.navacerrada

```

```{r}
 diff.navacerrada <- data.frame(abs(index.trmm.navacerrada-index.obs.navacerrada),abs(index.cal.navacerrada.scaling-index.obs.navacerrada),
                      abs(index.cal.navacerrada.eqm-index.obs.navacerrada),abs(index.cal.navacerrada.eqm.extrapol-index.obs.navacerrada), abs(index.cal.navacerrada.pqm-index.obs.navacerrada), abs(index.cal.navacerrada.gpqm-index.obs.navacerrada)
                      )
colnames(diff.navacerrada) <- c("TRMM","Scaling cal.", "EQM cal.","EQM extrapol cal.", "PQM cal.","GPQM cal.")

diff.navacerrada <- format(diff.navacerrada, digits = 3, scientific = 5)

diff.navacerrada
```
```{r}
 diff.navacerrada.noabs <- data.frame(index.trmm.navacerrada-index.obs.navacerrada,index.cal.navacerrada.scaling-index.obs.navacerrada,
                      index.cal.navacerrada.eqm-index.obs.navacerrada, index.cal.navacerrada.eqm.extrapol-index.obs.navacerrada, index.cal.navacerrada.pqm-index.obs.navacerrada, index.cal.navacerrada.gpqm-index.obs.navacerrada)
colnames(diff.navacerrada.noabs) <- c("TRMM","Scaling_cal", "EQM_cal","EQM_cal.Extrapol", "PQM_cal","GPQM_cal")


formattable(diff.navacerrada.noabs, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Scaling_cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Scaling_cal > 0,"red",
                                                  ifelse(Scaling_cal == 0,"black",
                                                         ifelse(Scaling_cal <0, "blue",NA))))),
  
   'EQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(EQM_cal > 0,"red",
                                                  ifelse(EQM_cal == 0,"black",
                                                         ifelse(EQM_cal <0, "blue",NA))))),
   'EQM_cal.Extrapol' = formatter("span",
                         style = ~style(font.weight = "bold", color =
                                           ifelse(EQM_cal.Extrapol > 0,"red",
                                                  ifelse(EQM_cal.Extrapol == 0,"black",
                                                         ifelse(EQM_cal.Extrapol <0, "blue",NA))))),
   'PQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(PQM_cal > 0,"red",
                                                  ifelse(PQM_cal == 0,"black",
                                                         ifelse(PQM_cal <0, "blue",NA))))),
   'GPQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(GPQM_cal > 0,"red",
                                                  ifelse(GPQM_cal == 0,"black",
                                                         ifelse(GPQM_cal <0, "blue",NA)))))
 ))
```

```{r}
plot(density(obs.navacerrada$Data, na.rm = TRUE),
main = "Obs, TRMM and Scaling cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.navacerrada$Data, na.rm = TRUE), col = "red")
lines(density(cal.navacerrada.scaling$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "Scaling calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.navacerrada$Data, trmm.navacerrada$Data, main = "Obs,TRMM and Scaling calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.navacerrada$Data), sort(cal.navacerrada.scaling$Data), col = "blue")

legend("topleft", legend = c("TRMM", "Scaling calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.navacerrada$Data, na.rm = TRUE),
main = "Obs, TRMM and EQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.navacerrada$Data, na.rm = TRUE), col = "red")
lines(density(cal.navacerrada.eqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "EQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.navacerrada$Data, trmm.navacerrada$Data, main = "Obs,TRMM and EQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.navacerrada$Data), sort(cal.navacerrada.eqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "EQM calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.navacerrada$Data, na.rm = TRUE),
main = "Obs, TRMM and EQM extrapol cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.navacerrada$Data, na.rm = TRUE), col = "red")
lines(density(cal.navacerrada.eqm.extrapol$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "EQM extrapol calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.navacerrada$Data, trmm.navacerrada$Data, main = "Obs,TRMM and EQM extrapol calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.navacerrada$Data), sort(cal.navacerrada.eqm.extrapol$Data), col = "blue")

legend("topleft", legend = c("TRMM", "EQM extrapol calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.navacerrada$Data, na.rm = TRUE),
main = "Obs, TRMM and PQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.navacerrada$Data, na.rm = TRUE), col = "red")
lines(density(cal.navacerrada.pqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "PQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.navacerrada$Data, trmm.navacerrada$Data, main = "Obs,TRMM and PQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.navacerrada$Data), sort(cal.navacerrada.pqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "PQMcalibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.navacerrada$Data, na.rm = TRUE),
main = "Obs, TRMM and GPQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.navacerrada$Data, na.rm = TRUE), col = "red")
lines(density(cal.navacerrada.gpqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "GPQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.navacerrada$Data, trmm.navacerrada$Data, main = "Obs,TRMM and GPQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.navacerrada$Data), sort(cal.navacerrada.gpqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "GPQM calibration"), pch = 1, col = c("red", "blue"))
```

# Santiago de Compostela

```{r eval=TRUE, message=FALSE}
obs.santiago <- subsetGrid(obs, station.id = obs$Metadata$station_id[9])
idx <- which.min(abs(trmm$xyCoords$x - obs.santiago$xyCoords$x))
lon <- trmm$xyCoords$x[idx]
  
idx2 <- which.min(abs(trmm$xyCoords$y - obs.santiago$xyCoords$y))
lat <- trmm$xyCoords$y[idx2]
  
trmm.santiago <- subsetGrid(trmm, lonLim = lon, latLim = lat)

index.obs.santiago <- valueIndex1D(obs.santiago$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

index.trmm.santiago <- valueIndex1D(trmm.santiago$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

index.obs.santiago.rv13max <- MaxReturnValue(obs.santiago)
index.trmm.santiago.rv13max <- MaxReturnValue(trmm.santiago)


cal.santiago.scaling <- biasCorrection(y = obs.santiago, x = trmm.santiago, newdata = trmm.santiago, precipitation = TRUE, cross.val = "loo", method = "scaling", scaling.type = "multiplicative")

cal.santiago.scaling$Dates$start <- as.POSIXct(cal.santiago.scaling$Dates$start,tz = "GMT")
cal.santiago.scaling$Dates$end <- as.POSIXct(cal.santiago.scaling$Dates$end,tz = "GMT")

index.cal.santiago.scaling.rv13max <- MaxReturnValue(cal.santiago.scaling)

index.cal.santiago.scaling <- valueIndex1D(cal.santiago.scaling$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.santiago.eqm <- biasCorrection(y = obs.santiago, x = trmm.santiago, newdata = trmm.santiago, precipitation = TRUE, cross.val = "loo", method = "eqm")

cal.santiago.eqm$Dates$start <- as.POSIXct(cal.santiago.eqm$Dates$start,tz = "GMT")
cal.santiago.eqm$Dates$end <- as.POSIXct(cal.santiago.eqm$Dates$end,tz = "GMT")

index.cal.santiago.eqm.rv13max <- MaxReturnValue(cal.santiago.eqm)

index.cal.santiago.eqm <- valueIndex1D(cal.santiago.eqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.santiago.eqm.extrapol <- biasCorrection(y = obs.santiago, x = trmm.santiago, newdata = trmm.santiago, precipitation = TRUE, cross.val = "loo", method = "eqm", extrapolation = "constant")

cal.santiago.eqm.extrapol$Dates$start <- as.POSIXct(cal.santiago.eqm.extrapol$Dates$start,tz = "GMT")
cal.santiago.eqm.extrapol$Dates$end <- as.POSIXct(cal.santiago.eqm.extrapol$Dates$end,tz = "GMT")

index.cal.santiago.eqm.extrapol.rv13max <- MaxReturnValue(cal.santiago.eqm.extrapol)


index.cal.santiago.eqm.extrapol <- valueIndex1D(cal.santiago.eqm.extrapol$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.santiago.pqm <- biasCorrection(y = obs.santiago, x = trmm.santiago, newdata = trmm.santiago, precipitation = TRUE, cross.val = "loo", method = "pqm",  fitdistr.args = list(densfun = "gamma"))

cal.santiago.pqm$Dates$start <- as.POSIXct(cal.santiago.pqm$Dates$start,tz = "GMT")
cal.santiago.pqm$Dates$end <- as.POSIXct(cal.santiago.pqm$Dates$end,tz = "GMT")

index.cal.santiago.pqm.rv13max <- MaxReturnValue(cal.santiago.pqm)

index.cal.santiago.pqm <- valueIndex1D(cal.santiago.pqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))

cal.santiago.gpqm <- biasCorrection(y = obs.santiago, x = trmm.santiago, newdata = trmm.santiago, precipitation = TRUE, cross.val = "loo", method = "gpqm", theta = 0.7)

cal.santiago.gpqm$Dates$start <- as.POSIXct(cal.santiago.gpqm$Dates$start,tz = "GMT")
cal.santiago.gpqm$Dates$end <- as.POSIXct(cal.santiago.gpqm$Dates$end,tz = "GMT")

index.cal.santiago.gpqm.rv13max <- MaxReturnValue(cal.santiago.gpqm)

index.cal.santiago.gpqm <- valueIndex1D(cal.santiago.gpqm$Data,index.codes=c("Skewness","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
```

```{r}

index.obs.santiago <- c(index.obs.santiago,index.obs.santiago.rv13max)
index.trmm.santiago <- c(index.trmm.santiago,index.trmm.santiago.rv13max)
index.cal.santiago.scaling <- c(index.cal.santiago.scaling,index.cal.santiago.scaling.rv13max)
index.cal.santiago.eqm <- c(index.cal.santiago.eqm,index.cal.santiago.eqm.rv13max)
index.cal.santiago.eqm.extrapol <- c(index.cal.santiago.eqm.extrapol,index.cal.santiago.eqm.extrapol.rv13max)
index.cal.santiago.pqm <- c(index.cal.santiago.pqm,index.cal.santiago.pqm.rv13max)
index.cal.santiago.gpqm <- c(index.cal.santiago.gpqm,index.cal.santiago.gpqm.rv13max)

results.santiago <- data.frame(index.obs.santiago, index.trmm.santiago, index.cal.santiago.scaling,
                      index.cal.santiago.eqm,index.cal.santiago.eqm.extrapol, index.cal.santiago.pqm, index.cal.santiago.gpqm
                      )
colnames(results.santiago) <- c("Obs","TRMM","Scaling cal.", "EQM cal.","EQM extrapol cal.", "PQM cal.","GPQM cal.")

results.santiago <- format(results.santiago, digits = 3, scientific = 5)

results.santiago

```

```{r}
 diff.santiago <- data.frame(abs(index.trmm.santiago-index.obs.santiago),abs(index.cal.santiago.scaling-index.obs.santiago),
                      abs(index.cal.santiago.eqm-index.obs.santiago),abs(index.cal.santiago.eqm.extrapol-index.obs.santiago), abs(index.cal.santiago.pqm-index.obs.santiago), abs(index.cal.santiago.gpqm-index.obs.santiago)
                      )
colnames(diff.santiago) <- c("TRMM","Scaling cal.", "EQM cal.","EQM extrapol cal.", "PQM cal.","GPQM cal.")

diff.santiago <- format(diff.santiago, digits = 3, scientific = 5)

diff.santiago
```
```{r}
 diff.santiago.noabs <- data.frame(index.trmm.santiago-index.obs.santiago,index.cal.santiago.scaling-index.obs.santiago,
                      index.cal.santiago.eqm-index.obs.santiago, index.cal.santiago.eqm.extrapol-index.obs.santiago, index.cal.santiago.pqm-index.obs.santiago, index.cal.santiago.gpqm-index.obs.santiago)
colnames(diff.santiago.noabs) <- c("TRMM","Scaling_cal", "EQM_cal","EQM_cal.Extrapol", "PQM_cal","GPQM_cal")


formattable(diff.santiago.noabs, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Scaling_cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Scaling_cal > 0,"red",
                                                  ifelse(Scaling_cal == 0,"black",
                                                         ifelse(Scaling_cal <0, "blue",NA))))),
  
   'EQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(EQM_cal > 0,"red",
                                                  ifelse(EQM_cal == 0,"black",
                                                         ifelse(EQM_cal <0, "blue",NA))))),
   'EQM_cal.Extrapol' = formatter("span",
                         style = ~style(font.weight = "bold", color =
                                           ifelse(EQM_cal.Extrapol > 0,"red",
                                                  ifelse(EQM_cal.Extrapol == 0,"black",
                                                         ifelse(EQM_cal.Extrapol <0, "blue",NA))))),
   'PQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(PQM_cal > 0,"red",
                                                  ifelse(PQM_cal == 0,"black",
                                                         ifelse(PQM_cal <0, "blue",NA))))),
   'GPQM_cal' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(GPQM_cal > 0,"red",
                                                  ifelse(GPQM_cal == 0,"black",
                                                         ifelse(GPQM_cal <0, "blue",NA)))))
 ))
```

```{r}
plot(density(obs.santiago$Data, na.rm = TRUE),
main = "Obs, TRMM and Scaling cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.santiago$Data, na.rm = TRUE), col = "red")
lines(density(cal.santiago.scaling$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "Scaling calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.santiago$Data, trmm.santiago$Data, main = "Obs,TRMM and Scaling calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.santiago$Data), sort(cal.santiago.scaling$Data), col = "blue")

legend("topleft", legend = c("TRMM", "Scaling calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.santiago$Data, na.rm = TRUE),
main = "Obs, TRMM and EQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.santiago$Data, na.rm = TRUE), col = "red")
lines(density(cal.santiago.eqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "EQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.santiago$Data, trmm.santiago$Data, main = "Obs,TRMM and EQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.santiago$Data), sort(cal.santiago.eqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "EQM calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.santiago$Data, na.rm = TRUE),
main = "Obs, TRMM and EQM extrapol cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.santiago$Data, na.rm = TRUE), col = "red")
lines(density(cal.santiago.eqm.extrapol$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "EQM extrapol calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.santiago$Data, trmm.santiago$Data, main = "Obs,TRMM and EQM extrapol calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.santiago$Data), sort(cal.santiago.eqm.extrapol$Data), col = "blue")

legend("topleft", legend = c("TRMM", "EQM extrapol calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.santiago$Data, na.rm = TRUE),
main = "Obs, TRMM and PQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.santiago$Data, na.rm = TRUE), col = "red")
lines(density(cal.santiago.pqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "PQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.santiago$Data, trmm.santiago$Data, main = "Obs,TRMM and PQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.santiago$Data), sort(cal.santiago.pqm$Data), col = "blue")

legend("topleft", legend = c("Observation", "PQM calibration"), pch = 1, col = c("red", "blue"))
```

```{r}
plot(density(obs.santiago$Data, na.rm = TRUE),
main = "Obs, TRMM and GPQM cal. density function",
xlab = "Precip amount (mm)")
grid()
lines(density(trmm.santiago$Data, na.rm = TRUE), col = "red")
lines(density(cal.santiago.gpqm$Data, na.rm = TRUE), col = "blue")
legend("topright", legend = c("Observation","TRMM", "GPQM calibration"), pch ='-', col = c("black", "red", "blue"))
```
```{r}
qqplot(obs.santiago$Data, trmm.santiago$Data, main = "Obs,TRMM and GPQM calibration QQplot", xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "red")

abline(a = 0, b = 1)

points(sort(obs.santiago$Data), sort(cal.santiago.gpqm$Data), col = "blue")

legend("topleft", legend = c("TRMM", "GPQM calibration"), pch = 1, col = c("red", "blue"))
```
# Merged QQplots

```{r}
severalQQPlot <- function(obs, trmm, scaling, eqm, eqm.extrapol, pqm, gpqm, leg){
  qqplot(obs$Data, trmm$Data, main = paste(obs$Metadata$name), xlab = "Observed (mm)", ylab = "TRMM/Calibration (mm)", col = "black", pch = 2, cex = .5)

abline(a = 0, b = 1)

points(sort(obs$Data), sort(scaling$Data), col = "pink", pch = 4, cex = .5)
points(sort(obs$Data), sort(eqm$Data), col = "red", pch = 4, cex = .5)
points(sort(obs$Data), sort(eqm.extrapol$Data), col = "blue", pch = 19, cex = .5)
points(sort(obs$Data), sort(pqm$Data), col = "gold", pch = 19, cex = .5)
points(sort(obs$Data), sort(gpqm$Data), col = "forestgreen", pch = 19, cex = .5)

grid() 

if(leg){
  legend("topleft", legend = c("TRMM","Scaling","EQM", "EQM extrapol", "PQM","GPQM"), pch = c(2,4,4,19,19,19), col = c("black", "pink","red","blue","gold","forestgreen"))
}

}
```

```{r}
severalQQPlot(obs.santiago,trmm.santiago,cal.santiago.scaling, cal.santiago.eqm, cal.santiago.eqm.extrapol, cal.santiago.pqm, cal.santiago.gpqm, leg = T)
```

```{r}

par(oma = c(3.7,1,1,1), mfrow = c(2, 3), mar = c(2, 2, 1, 1))


severalQQPlot(obs.madrid,trmm.madrid,cal.madrid.scaling, cal.madrid.eqm, cal.madrid.eqm.extrapol, cal.madrid.pqm, cal.madrid.gpqm, leg = F)

severalQQPlot(obs.malaga,trmm.malaga,cal.malaga.scaling, cal.malaga.eqm, cal.malaga.eqm.extrapol, cal.malaga.pqm, cal.malaga.gpqm, leg = F)

severalQQPlot(obs.mallorca,trmm.mallorca,cal.mallorca.scaling, cal.mallorca.eqm, cal.mallorca.eqm.extrapol, cal.mallorca.pqm, cal.mallorca.gpqm, leg = F)

severalQQPlot(obs.sansebastian,trmm.sansebastian,cal.sansebastian.scaling, cal.sansebastian.eqm, cal.sansebastian.eqm.extrapol, cal.sansebastian.pqm, cal.sansebastian.gpqm, leg = F)

severalQQPlot(obs.navacerrada,trmm.navacerrada,cal.navacerrada.scaling, cal.navacerrada.eqm, cal.navacerrada.eqm.extrapol, cal.navacerrada.pqm, cal.navacerrada.gpqm, leg = F)

severalQQPlot(obs.santiago,trmm.santiago,cal.santiago.scaling, cal.santiago.eqm, cal.santiago.eqm.extrapol, cal.santiago.pqm, cal.santiago.gpqm, leg = F)

mtext("Observed(mm)",side=1,line=0,outer=TRUE,cex=0.7)
mtext("TRMM/Calibration(mm)",side=2,line=0,outer=TRUE,cex=0.7,las=0)

par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)
plot(0, 0, type = 'l', bty = 'n', xaxt = 'n', yaxt = 'n')
   
legend(x = "bottom",
        legend = c("TRMM","Scaling","EQM", "EQM extrapol", "PQM","GPQM"), pch = c(2,4,4,19,19,19), col = c("black", "pink","red","blue","gold","forestgreen"), horiz = TRUE)

```

