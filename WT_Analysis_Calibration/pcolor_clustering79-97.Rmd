---
title: "WT-associated clustering in the South Pacific Basin during 1979-1997 period"
output: html_notebook
---
```{r}
if (dir.exists("C:/Users/usuario/Desktop/TRMM-Calibration/Data")) {
  dir <- "C:/Users/usuario/Desktop/TRMM-Calibration/Data"
}else{
  dir <- "/vols/seal/oceano/gmeteo/WORK/juaco/trmm/clustering"
}
```

```{r setup}
knitr::opts_knit$set(root.dir = dir)
```


```{r}
library(downscaleR)
library(visualizeR)
library(convertR)
library(ncdf4)
library(climate4R.value)
library(magrittr)
library(evd)
library(formattable) #neccessary to create tables with colors
library(lubridate) #neccessary to calculate differences in years between dates
library(lattice)
library(ggplot2)
library(raster)
library(rasterVis)
library(sp)
library(grid)
library(clue)
```

```{r}
set.seed(42)
load("pca.projected2.RData")
load("pp_reanalysis_complete2.RData")
load("pca.RData")
```

```{r}
par(mfrow=c(3,2))

plot(pca$tp[[1]]$PCs, main = "PC1 vs PC2 tp Old PCA")
plot(pca.projected$tp[[1]], main = "PC1 vs PC2 tp Projecteed PCA")

plot(pca$msl[[1]]$PCs, main = "PC1 vs PC2 slp Old PCA")
plot(pca.projected$msl[[1]], main = "PC1 vs PC2 slp Projected PCA")

plot(pca$diff_msl[[1]]$PCs, main = "PC1 vs PC2 diff slp Old PCA")
plot(pca.projected$diff_slp[[1]], main = "PC1 vs PC2 diff slp Projected PCA")
```


```{r}
pp.complete <- subsetGrid(pp.complete, years = 1979:1997)
```

```{r}
k = 5
load('kmModel5.RData')
```

```{r}
pca.projected.matrix <- cbind(pca.projected$tp[[1]],pca.projected$msl[[1]],pca.projected$diff_slp[[1]])
```

```{r}
clustering <- cl_predict(kmModel5, pca.projected.matrix, type = "class_ids")
```



```{r}
size <- c()
for (i in c(1:k)) {
  size <- c(size,length(which(clustering == i)))
}
```

```{r}
lista <- lapply(1:k, function(x) subsetDimension(pp.complete, dimension = "time", indices = which(clustering == x)) %>% climatology())

kmedias.pp <- bindGrid(lista, dimension = "member", skip.temporal.check = TRUE)

spatialPlot(kmedias.pp,backdrop.theme = 'countries', rev.color = T, as.table = T, names.attr = paste("Days in cluster", 1:k, ":", size[1:k]))
```

```{r}
b <- boxplot(aggregateGrid(pp.complete, aggr.lat = list(FUN = "mean"), aggr.lon = list(FUN = "mean"))$Data~clustering, main = "Precipitation Data for each cluster")
```

```{r}
violinPlot("Cluster1" = subsetGrid(kmedias.pp, members = 1), "Cluster2" = subsetGrid(kmedias.pp, members = 2),"Cluster3" = subsetGrid(kmedias.pp, members = 3),"Cluster4" = subsetGrid(kmedias.pp, members = 4), "Cluster5" = subsetGrid(kmedias.pp, members = 5))
```


```{r}
cyclones <- read.csv('C:/Users/usuario/Desktop/Master/tfm/Notebooks_TFM/SP_cyclones_time_series_1979_2020.csv')
cyclones$Date <- as.Date(cyclones$Date)
idx.cyc <- which(cyclones$Date < as.Date("1998-01-01"))
cyclones <- cyclones[idx.cyc,2:3]
```

```{r}
cl1 <- subsetDimension(pp.complete, dimension = "time", indices = which(clustering == 1))
cl2 <- subsetDimension(pp.complete, dimension = "time", indices = which(clustering == 2))
cl3 <- subsetDimension(pp.complete, dimension = "time", indices = which(clustering == 3))
cl4 <- subsetDimension(pp.complete, dimension = "time", indices = which(clustering == 4))
cl5 <- subsetDimension(pp.complete, dimension = "time", indices = which(clustering == 5))
```

```{r}
cyclones.cl.1 <- cyclones[which(clustering ==1 ),]
cyclones.cl.2 <- cyclones[which(clustering ==2 ),]
cyclones.cl.3 <- cyclones[which(clustering ==3 ),]
cyclones.cl.4 <- cyclones[which(clustering ==4 ),]
cyclones.cl.5 <- cyclones[which(clustering ==5 ),]

cluster1 <- c()
cluster2 <- c()
cluster3 <- c()
cluster4 <- c()
cluster5 <- c()

cyc.cluster1 <- c()
cyc.cluster2 <- c()
cyc.cluster3 <- c()
cyc.cluster4 <- c()
cyc.cluster5 <- c()

for (i in c(1:12)) {
  cluster1 <- c(cluster1, length(subsetSeason(cl1, season = i)$Dates$start))
  cluster2 <- c(cluster2, length(subsetSeason(cl2, season = i)$Dates$start))
  cluster3 <- c(cluster3, length(subsetSeason(cl3, season = i)$Dates$start))
  if (i == 9) {
    cluster4 <- c(cluster4,0)
  }else{
    cluster4 <- c(cluster4, length(subsetSeason(cl4, season = i)$Dates$start))
  }
  cluster5 <- c(cluster5, length(subsetSeason(cl5, season = i)$Dates$start))
  
  
  idx <- which(as.numeric(format(cyclones.cl.1$Date, "%m")) == i)
  cyc.cluster1 <- c(cyc.cluster1,sum(cyclones.cl.1$cyclones_generation_centers[idx]))
  idx <- which(as.numeric(format(cyclones.cl.2$Date, "%m")) == i)
  cyc.cluster2 <- c(cyc.cluster2,sum(cyclones.cl.2$cyclones_generation_centers[idx]))
  idx <- which(as.numeric(format(cyclones.cl.3$Date, "%m")) == i)
  cyc.cluster3 <- c(cyc.cluster3,sum(cyclones.cl.3$cyclones_generation_centers[idx]))
  idx <- which(as.numeric(format(cyclones.cl.4$Date, "%m")) == i)
  cyc.cluster4 <- c(cyc.cluster4,sum(cyclones.cl.4$cyclones_generation_centers[idx]))
  idx <- which(as.numeric(format(cyclones.cl.5$Date, "%m")) == i)
  cyc.cluster5 <- c(cyc.cluster5,sum(cyclones.cl.5$cyclones_generation_centers[idx]))
}

x <- seq(1,5)
y <- seq(1,12)
data <- expand.grid(X=x, Y=y)
data$Z <- as.vector(t(matrix(c(cluster1,cluster2,cluster3,cluster4,cluster5), nrow = 12,ncol = 5)))


cyc.data <- expand.grid(X=x, Y=y)
cyc.data$Z <- as.vector(t(matrix(c(cyc.cluster1,cyc.cluster2,cyc.cluster3,cyc.cluster4,cyc.cluster5), nrow = 12,ncol = 5)))
levelplot(Z ~ Y*X, data=data  ,xlab="Month", ylab = "WT",
          main="", col.regions = rev(hcl.colors(100,palette = 'GnBu')))

grid.text("N Obs", .94, .13)
```
```{r}
coordinates(cyc.data) <- ~Y+X

levelplot(Z ~ Y*X, data=data  ,xlab="Month", ylab = "WT",
          main="", col.regions = rev(hcl.colors(100,palette = 'GnBu')))+
  layer(sp.points(cyc.data, pch = 19, cex = cyc.data$Z/350, col = 'blue'))+
   layer(panel.segments(10.5,1.5,12.5,1.5, col = 'blue', lwd = 2))+
  layer(panel.segments(10.5,0.5,10.5,1.5, col = 'blue', lwd = 2))+
  layer(panel.segments(10.5,0.5,12.5,0.5, col = 'blue', lwd = 2))+
  layer(panel.segments(0.5,1.5,5.5,1.5, col = 'blue', lwd = 2))+
  layer(panel.segments(5.5,0.5,5.5,1.5, col = 'blue', lwd = 2))+
  layer(panel.segments(0.5,0.5,5.5,0.5, col = 'blue', lwd = 2))+
  
  layer(panel.segments(10.5,2.5,12.5,2.5, col = 'blue', lwd = 2))+
  layer(panel.segments(10.5,1.5,10.5,2.5, col = 'blue', lwd = 2))+
  layer(panel.segments(0.5,2.5,6.5,2.5, col = 'blue', lwd = 2))+
  layer(panel.segments(6.5,1.5,6.5,2.5, col = 'blue', lwd = 2))+
  layer(panel.segments(5.5,1.5,6.5,1.5, col = 'blue', lwd = 2))+
  
  layer(panel.segments(3.5,3.5,10.5,3.5, col = 'blue', lwd = 2))+
  layer(panel.segments(6.5,2.5,10.5,2.5, col = 'blue', lwd = 2))+
  layer(panel.segments(3.5,2.5,3.5,2.5, col = 'blue', lwd = 2))+
  layer(panel.segments(10.5,2.5,10.5,3.5, col = 'blue', lwd = 2))+
  layer(panel.segments(3.5,2.5,3.5,3.5, col = 'blue', lwd = 2))+
  
  
  layer(panel.segments(0.5,4.5,3.5,4.5, col = 'blue', lwd = 2))+
  layer(panel.segments(0.5,3.5,3.5,3.5, col = 'blue', lwd = 2))+
  layer(panel.segments(3.5,3.5,3.5,4.5, col = 'blue', lwd = 2))+
  layer(panel.segments(11.5,3.5,12.5,3.5, col = 'blue', lwd = 2))+
  layer(panel.segments(11.5,4.5,12.5,4.5, col = 'blue', lwd = 2))+
  layer(panel.segments(11.5,3.5,11.5,4.5, col = 'blue', lwd = 2))+
  
  layer(panel.segments(3.5,4.5,10.5,4.5, col = 'blue', lwd = 2))+
  layer(panel.segments(3.5,5.49,10.5,5.49, col = 'blue', lwd = 2))+
  layer(panel.segments(3.5,4.5,3.5,5.49, col = 'blue', lwd = 2))+
  layer(panel.segments(10.5,4.5,10.5,5.49, col = 'blue', lwd = 2))

grid.text("N Obs", .94, .13)

```


```{r}
getWTSeason <- function(cluster, threshold){
  lista <- list()
  pp.season <- c()
  for (i in c(1:12)) {

    if (length(which(month(cluster$Dates$start) == i)) > 0){
      
      lista[[length(lista)+1]] <- subsetSeason(cluster, season = i)
      pp.season <- c(pp.season, sum(lista[[i]]$Data))
      
    }else{
      lista[[length(lista)+1]] <- 0
      pp.season <- c(pp.season, 0)
    }
  }

  names(pp.season) <- c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")
  
  pp.season <- sort(pp.season, decreasing = TRUE)
  idx <- which((cumsum(pp.season)/sum(pp.season)) >= threshold)[1]
  pp.season[(idx+1):12] <- 0
  pp.season[1:idx] <- pp.season[1:idx]/sum(pp.season[1:idx])
  
  return(pp.season)
}

```

```{r}
pp.season.cl1 <- getWTSeason(cl1, .8)

barplot(pp.season.cl1, names.arg = names(pp.season.cl1), col = 'blue', 
        main = "Normalized precipitation in each month in Cl1")
```

```{r}
seasons <- c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")

ordered.seasons <- c()
for (i in c(1:length(which(pp.season.cl1 > 0)))) {
  ordered.seasons <- c(ordered.seasons, which(names(which(pp.season.cl1 > 0))[i] == seasons) ) 
}

ordered.seasons <- sort(ordered.seasons)

if (length(which(diff(ordered.seasons) > 1)) > 0) {
  id.start <- ordered.seasons[which(diff(ordered.seasons) > 1)+1]
  id.end <- ordered.seasons[which(diff(ordered.seasons) > 1)]

  paste("Season starts in ", seasons[id.start],"and finishes in", seasons[id.end])
}else{
  paste("Season starts in ", seasons[ordered.seasons[1]],"and finishes in", seasons[ordered.seasons[length(ordered.seasons)]])
}
```

```{r}
pp.season.cl2 <- getWTSeason(cl2, .8)

barplot(pp.season.cl2, names.arg = names(pp.season.cl1), col = 'blue', 
        main = "Normalized precipitation in each month in Cl2")
```

```{r}
seasons <- c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")

ordered.seasons <- c()
for (i in c(1:length(which(pp.season.cl2 > 0)))) {
  ordered.seasons <- c(ordered.seasons, which(names(which(pp.season.cl2 > 0))[i] == seasons) ) 
}

ordered.seasons <- sort(ordered.seasons)

if (length(which(diff(ordered.seasons) > 1)) > 0) {
  id.start <- ordered.seasons[which(diff(ordered.seasons) > 1)+1]
  id.end <- ordered.seasons[which(diff(ordered.seasons) > 1)]

  paste("Season starts in ", seasons[id.start],"and finishes in", seasons[id.end])
}else{
  paste("Season starts in ", seasons[ordered.seasons[1]],"and finishes in", seasons[ordered.seasons[length(ordered.seasons)]])
}
```

```{r}
pp.season.cl3 <- getWTSeason(cl3, .8)

barplot(pp.season.cl3, names.arg = names(pp.season.cl3), col = 'blue', 
        main = "Normalized precipitation in each month in Cl3")
```

```{r}
seasons <- c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")

ordered.seasons <- c()
for (i in c(1:length(which(pp.season.cl3 > 0)))) {
  ordered.seasons <- c(ordered.seasons, which(names(which(pp.season.cl3 > 0))[i] == seasons) ) 
}

ordered.seasons <- sort(ordered.seasons)

if (length(which(diff(ordered.seasons) > 1)) > 0) {
  id.start <- ordered.seasons[which(diff(ordered.seasons) > 1)+1]
  id.end <- ordered.seasons[which(diff(ordered.seasons) > 1)]

  paste("Season starts in ", seasons[id.start],"and finishes in", seasons[id.end])
}else{
  paste("Season starts in ", seasons[ordered.seasons[1]],"and finishes in", seasons[ordered.seasons[length(ordered.seasons)]])
}
```

```{r}
pp.season.cl4 <- getWTSeason(cl4, .8)

barplot(pp.season.cl4, names.arg = names(pp.season.cl4), col = 'blue', 
        main = "Normalized precipitation in each month in Cl4")
```

```{r}
seasons <- c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")

ordered.seasons <- c()
for (i in c(1:length(which(pp.season.cl4 > 0)))) {
  ordered.seasons <- c(ordered.seasons, which(names(which(pp.season.cl4 > 0))[i] == seasons) ) 
}

ordered.seasons <- sort(ordered.seasons)

if (length(which(diff(ordered.seasons) > 1)) > 0) {
  id.start <- ordered.seasons[which(diff(ordered.seasons) > 1)+1]
  id.end <- ordered.seasons[which(diff(ordered.seasons) > 1)]

  paste("Season starts in ", seasons[id.start],"and finishes in", seasons[id.end])
}else{
  paste("Season starts in ", seasons[ordered.seasons[1]],"and finishes in", seasons[ordered.seasons[length(ordered.seasons)]])
}
```

```{r}
pp.season.cl5 <- getWTSeason(cl5, .8)

barplot(pp.season.cl5, names.arg = names(pp.season.cl5), col = 'blue', 
        main = "Normalized precipitation in each month in Cl5")
```

```{r}
seasons <- c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")

ordered.seasons <- c()
for (i in c(1:length(which(pp.season.cl5 > 0)))) {
  ordered.seasons <- c(ordered.seasons, which(names(which(pp.season.cl5 > 0))[i] == seasons) ) 
}

ordered.seasons <- sort(ordered.seasons)

if (length(which(diff(ordered.seasons) > 1)) > 0) {
  id.start <- ordered.seasons[which(diff(ordered.seasons) > 1)+1]
  id.end <- ordered.seasons[which(diff(ordered.seasons) > 1)]

  paste("Season starts in ", seasons[id.start],"and finishes in", seasons[id.end])
}else{
  paste("Season starts in ", seasons[ordered.seasons[1]],"and finishes in", seasons[ordered.seasons[length(ordered.seasons)]])
}
```


