---
title: "R Notebook"
output: html_notebook
---

```{r}
if (dir.exists("C:/Users/usuario/Desktop/TRMM-Calibration/Data")) {
  dir <- "C:/Users/usuario/Desktop/TRMM-Calibration/Data"
}else{
  dir <- "/vols/seal/oceano/gmeteo/WORK/juaco/trmm/clustering"
}
```

```{r setup}
knitr::opts_knit$set(root.dir = dir)
```

```{r}
library(downscaleR)
library(visualizeR)
library(convertR)
library(magrittr)
library(evd)
library(raster)
library(rasterVis)
library(sp)
library(grid)
library(RColorBrewer)
library(lubridate)
```

```{r}
load("pca.RData")
load("pp_reanalysis.RData")
```

```{r}
k = 5
load('kmModel5.RData')
```

```{r}
idx.tp <- which(attributes(pca$tp[[1]])$explained_variance >= .75)[1]
idx.msl <- which(attributes(pca$msl[[1]])$explained_variance >= .9)[1]
idx.diff.msl <- which(attributes(pca$diff_msl[[1]])$explained_variance >= .9)[1]

pca.matrix <- cbind(pca$tp[[1]]$PCs[,1:idx.tp],pca$msl[[1]]$PCs[,1:idx.msl],pca$diff_msl[[1]]$PCs[,1:idx.diff.msl])
```


```{r}
cyclones <- read.csv('C:/Users/usuario/Desktop/Master/tfm/Notebooks_TFM/SP_cyclones_time_series_1998_2020.csv')
cyclones$Date <- as.Date(cyclones$Date)
cyclones <- cyclones[,2:3]

```

```{r}
lista <- lapply(1:k, function(x) subsetDimension(pp_reanalysis, dimension = "time", indices = which(kmModel5$cluster == x)) %>% climatology())

kmedias.pp <- bindGrid(lista, dimension = "member", skip.temporal.check = TRUE)

spatialPlot(kmedias.pp,backdrop.theme = 'countries', rev.color = T, as.table = T, names.attr = paste("Days in cluster", 1:k, ":",kmModel5$size[1:k]))
```


```{r}
x <- seq(1,365)
y <- seq(1998,2020)

data <- expand.grid(X=x, Y=y)
data$Z <- as.vector(matrix(kmModel5$cluster, nrow = 23,ncol = 365))

data$Z <- as.character(data$Z)

levelplot(Z ~ X*Y, data=data  ,xlab="Season", ylab = "Years",scales=list(x=list(at=NULL)),
          main="", col.regions =  c("#006837","#66C2A5","#FFFFBF","#5E4FA2","#F46D43"), at = 0:5)

grid.text("Feb", .18, .13, gp = gpar(cex = .8) )
grid.text("Mar", .24, .13, gp = gpar(cex = .8) )
grid.text("Apr", .3, .13, gp = gpar(cex = .8) )
grid.text("May", .37, .13, gp = gpar(cex = .8) )
grid.text("Jun", .435, .13, gp = gpar(cex = .8) )
grid.text("Jul", .495, .13, gp = gpar(cex = .8) )
grid.text("Aug", .56, .13, gp = gpar(cex = .8) )
grid.text("Sep", .63, .13, gp = gpar(cex = .8) )
grid.text("Oct", .69, .13, gp = gpar(cex = .8) )
grid.text("Nov", .76, .13, gp = gpar(cex = .8) )
grid.text("Dec", .82, .13, gp = gpar(cex = .8) )
```

```{r}
cyc.data <- expand.grid(X=x, Y=y)
cyc.data$Z <- as.vector(matrix(cyclones$cyclones_generation_centers, nrow = 23,ncol = 365))
```

```{r}
idx <- which(cyc.data$Z > 0)
cyc.data$Z[idx] = 1
coordinates(cyc.data) <- ~ X+Y
```




```{r}
levelplot(Z ~ X*Y, data=data  ,xlab="Season", ylab = "Years", scales=list(x=list(at=NULL)),
          main="", col.regions = c("#006837","#66C2A5","#FFFFBF","#5E4FA2","#F46D43"), at = 0:5) +
  layer(sp.points(cyc.data, pch = 21, cex = cyc.data$Z/50, col = 'white'))

grid.text("Feb", .18, .13, gp = gpar(cex = .8) )
grid.text("Mar", .24, .13, gp = gpar(cex = .8) )
grid.text("Apr", .3, .13, gp = gpar(cex = .8) )
grid.text("May", .37, .13, gp = gpar(cex = .8) )
grid.text("Jun", .435, .13, gp = gpar(cex = .8) )
grid.text("Jul", .495, .13, gp = gpar(cex = .8) )
grid.text("Aug", .56, .13, gp = gpar(cex = .8) )
grid.text("Sep", .63, .13, gp = gpar(cex = .8) )
grid.text("Oct", .69, .13, gp = gpar(cex = .8) )
grid.text("Nov", .76, .13, gp = gpar(cex = .8) )
grid.text("Dec", .82, .13, gp = gpar(cex = .8) )
```

```{r}
levelplot(Z ~ X*Y, data=data  ,xlab="Days", ylab = "Years", scales=list(x=list(at=NULL)),
          main="", col.regions = c("#006837","#66C2A5","#FFFFBF","#5E4FA2","#F46D43"), at = 0:5) +
  layer(sp.points(cyc.data, pch = 21, cex = cyc.data$Z/50, col = 'white'))+
  layer(panel.segments(31,1997.5,31,2020.5, col = 'lavender', lwd =2))+
  layer(panel.segments(59,1997.5,59,2020.5, col = 'lavender', lwd =2))+
  layer(panel.segments(90,1997.5,90,2020.5, col = 'lavender', lwd =2))+
  layer(panel.segments(120,1997.5,120,2020.5, col = 'lavender', lwd =2))+
  layer(panel.segments(151,1997.5,151,2020.5, col = 'lavender', lwd =2))+
  layer(panel.segments(181,1997.5,181,2020.5, col = 'lavender', lwd =2))+
  layer(panel.segments(212,1997.5,212,2020.5, col = 'lavender', lwd =2))+
  layer(panel.segments(243,1997.5,243,2020.5, col = 'lavender', lwd =2))+
  layer(panel.segments(273,1997.5,273,2020.5, col = 'lavender', lwd =2))+
  layer(panel.segments(304,1997.5,304,2020.5, col = 'lavender', lwd =2))+
  layer(panel.segments(334,1997.5,334,2020.5, col = 'lavender', lwd =2))

grid.text("Feb", .18, .13, gp = gpar(cex = .8) )
grid.text("Mar", .24, .13, gp = gpar(cex = .8) )
grid.text("Apr", .3, .13, gp = gpar(cex = .8) )
grid.text("May", .37, .13, gp = gpar(cex = .8) )
grid.text("Jun", .435, .13, gp = gpar(cex = .8) )
grid.text("Jul", .495, .13, gp = gpar(cex = .8) )
grid.text("Aug", .56, .13, gp = gpar(cex = .8) )
grid.text("Sep", .63, .13, gp = gpar(cex = .8) )
grid.text("Oct", .69, .13, gp = gpar(cex = .8) )
grid.text("Nov", .76, .13, gp = gpar(cex = .8) )
grid.text("Dec", .82, .13, gp = gpar(cex = .8) )
```



