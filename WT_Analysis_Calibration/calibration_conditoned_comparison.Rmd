---
title: "Calibration conditioned to weather types in several locations"
author: "Ã“scar Mirones Alonso"
output: 
  html_notebook:
    theme: united
    toc: yes
    toc_depth: 5
---
    
```{r}
library(loadeR)
library(transformeR)
library(downscaleR)
library(visualizeR)
library(convertR)
library(ncdf4)
library(climate4R.value)
library(magrittr)
library(evd)
library(formattable) #neccessary to create tables with colors
library(lubridate) #neccessary to calculate differences in years between dates
library(lattice)
library(ggplot2)
library(raster)
library(rasterVis)
library(sp)

if (dir.exists("C:/Users/usuario/Desktop/TRMM-Calibration/TRMM-time-series/WT_Analysis_Calibration")) {
  dir <- "C:/Users/usuario/Desktop/TRMM-Calibration/TRMM-time-series/WT_Analysis_Calibration"
}else{
  dir <- "/vols/seal/oceano/gmeteo/WORK/juaco/trmm/clustering"
}

```
```{r setup}
knitr::opts_knit$set(root.dir = dir)
```

```{r}
set.seed(42)

load("pca.RData")
load("pp_reanalysis.RData")
idx.tp <- which(attributes(pca$tp[[1]])$explained_variance >= .75)[1]
idx.msl <- which(attributes(pca$msl[[1]])$explained_variance >= .9)[1]
idx.diff.msl <- which(attributes(pca$diff_msl[[1]])$explained_variance >= .9)[1]

pca.matrix <- cbind(pca$tp[[1]]$PCs[,1:idx.tp],pca$msl[[1]]$PCs[,1:idx.msl],pca$diff_msl[[1]]$PCs[,1:idx.diff.msl])

k = 5
kmModel5 <- kmeans(pca.matrix, centers = k, nstart = 10)

kmModel5$cluster <- kmModel5$cluster[1:8034]
precip_obs <- loadStationData("SP_ascii.zip", var = "precip_obs")
precip_trmm <- loadStationData("SP_ascii.zip", var = "precip_trmm")

```

```{r}
MaxReturnValue <- function(data){
  #library(lubridate)
  #nyears <- round(time_length(difftime(cal.madrid.eqm$Dates$end[length(cal.madrid.eqm$Dates$end)], cal.madrid.eqm$Dates$start[1]),"years"))
  nyears <- 20
  data.maxYear <- aggregateGrid(redim(data), aggr.y = list(FUN = "max",na.rm = TRUE))

  data.maxrv <- climatology(data, clim.fun = list(FUN = "mean", na.rm = T))

  auxData <- data.maxYear$Data
  auxData[which(is.infinite(auxData))] <- NA

  if (any(!is.na(auxData))){
      auxGEV <- fgev(auxData)
      if ((auxGEV$estimate[3] - auxGEV$std.err[3] < 0) & (0  < auxGEV$estimate[3] + auxGEV$std.err[3])){
        auxGEV <- fgev(auxData, shape = 0)
        auxRV <- qgev(1-1/nyears, loc = auxGEV$estimate[1], scale = auxGEV$estimate[2], shape = 0)
      }else{
        auxRV <- qgev(1-1/nyears, loc = auxGEV$estimate[1], scale = auxGEV$estimate[2], shape = auxGEV$estimate[3])
      }
      data.maxrv <- as.numeric(auxRV)
      names(data.maxrv) <- paste("RV",nyears,"_max", sep = "")
  }
  return(data.maxrv)
  }
```

# Wallis and Futuna

```{r}
i=1


station.trmm <- subsetGrid(precip_trmm, station.id = precip_trmm$Metadata$station_id[i])
station.obs <- subsetGrid(precip_obs, station.id = precip_trmm$Metadata$station_id[i])
```

## PQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "pqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "pqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method ="pqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "pqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method ="pqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "pqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.pqm <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], cal.station$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.cal.conditioned$Data)],cal.station$Data[!is.na(cal.station$Data)],station.trmm$Data[!is.na(station.trmm$Data)]))))

abline(a = 0, b = 1)

points(station.obs$Data[!is.na(station.obs$Data)][order(station.obs$Data[!is.na(station.obs$Data)])], station.cal.conditioned$Data[!is.na(station.obs$Data)][order(station.cal.conditioned$Data[!is.na(station.obs$Data)])], col = "red", pch = 3, cex = .5)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("PQM-conditioned","PQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## EQM
```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "eqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "eqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "eqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "eqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "eqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "eqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.eqm <- index.cal.station.conditioned
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("EQM-conditioned","EQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## GPQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .95)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditioned.gpqm <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```
## GPQM theta = .7

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .7)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditioned.gpqm2 <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station.conditined.pqm, index.cal.station.conditined.eqm, index.cal.station.conditioned.gpqm, index.cal.station.conditioned.gpqm2)
colnames(df) <- c("Obs","TRMM","PQM Cond", "EQM Cond", "GPQM Cond", "GPQM Cond (Theta2")
format(df, digits = 3, scientific = 5)
```

```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```

# Hakupu, Niue
```{r}
i=2


station.trmm <- subsetGrid(precip_trmm, station.id = precip_trmm$Metadata$station_id[i])
station.obs <- subsetGrid(precip_obs, station.id = precip_trmm$Metadata$station_id[i])
```

## PQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "pqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "pqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method ="pqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "pqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method ="pqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "pqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.pqm <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.cal.conditioned$Data)],cal.station$Data[!is.na(cal.station$Data)],station.trmm$Data[!is.na(station.trmm$Data)]))))

abline(a = 0, b = 1)

points(station.obs$Data[!is.na(station.obs$Data)][order(station.obs$Data[!is.na(station.obs$Data)])], station.cal.conditioned$Data[!is.na(station.obs$Data)][order(station.cal.conditioned$Data[!is.na(station.obs$Data)])], col = "red", pch = 3, cex = .5)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("PQM-conditioned","PQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## EQM
```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "eqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "eqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "eqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "eqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "eqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "eqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.eqm <- index.cal.station.conditioned
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("EQM-conditioned","EQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## GPQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .95)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.gpqm <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```

## GPQM theta = .7

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .7)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.gpqm2 <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station.conditined.pqm, index.cal.station.conditined.eqm, index.cal.station.conditined.gpqm, index.cal.station.conditined.gpqm2)
colnames(df) <- c("Obs","TRMM","PQM Cond", "EQM Cond", "GPQM Cond", "GPQM Cond (Theta2")
format(df, digits = 3, scientific = 5)
```

```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```
# Raratonga International Airport, Cook Islands
```{r}
i=3


station.trmm <- subsetGrid(precip_trmm, station.id = precip_trmm$Metadata$station_id[i])
station.obs <- subsetGrid(precip_obs, station.id = precip_trmm$Metadata$station_id[i])
```

## PQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "pqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "pqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method ="pqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "pqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method ="pqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "pqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.pqm <- index.cal.station.conditioned
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.cal.conditioned$Data)],cal.station$Data[!is.na(cal.station$Data)],station.trmm$Data[!is.na(station.trmm$Data)]))))

abline(a = 0, b = 1)

points(station.obs$Data[!is.na(station.obs$Data)][order(station.obs$Data[!is.na(station.obs$Data)])], station.cal.conditioned$Data[!is.na(station.obs$Data)][order(station.cal.conditioned$Data[!is.na(station.obs$Data)])], col = "red", pch = 3, cex = .5)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("PQM-conditioned","PQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## EQM
```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "eqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "eqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "eqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "eqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "eqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "eqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.eqm <- index.cal.station.conditioned
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("EQM-conditioned","EQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## GPQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .95)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.gpqm <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```

## GPQM theta = .7

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .7)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.gpqm2 <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station.conditined.pqm, index.cal.station.conditined.eqm, index.cal.station.conditined.gpqm, index.cal.station.conditined.gpqm2)
colnames(df) <- c("Obs","TRMM","PQM Cond", "EQM Cond", "GPQM Cond", "GPQM Cond (Theta2")
format(df, digits = 3, scientific = 5)
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```
# Bells Beach, New Zealand
```{r}
i=4


station.trmm <- subsetGrid(precip_trmm, station.id = precip_trmm$Metadata$station_id[i])
station.obs <- subsetGrid(precip_obs, station.id = precip_trmm$Metadata$station_id[i])
```

## PQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "pqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "pqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method ="pqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "pqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method ="pqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "pqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.pqm <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.cal.conditioned$Data)],cal.station$Data[!is.na(cal.station$Data)],station.trmm$Data[!is.na(station.trmm$Data)]))))

abline(a = 0, b = 1)

points(station.obs$Data[!is.na(station.obs$Data)][order(station.obs$Data[!is.na(station.obs$Data)])], station.cal.conditioned$Data[!is.na(station.obs$Data)][order(station.cal.conditioned$Data[!is.na(station.obs$Data)])], col = "red", pch = 3, cex = .5)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("PQM-conditioned","PQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## EQM
```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "eqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "eqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "eqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "eqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "eqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "eqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.eqm <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```

```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("EQM-conditioned","EQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## GPQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .95)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.gpqm <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```

```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```
## GPQM theta = .7

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .7)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.gpqm2 <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station.conditined.pqm, index.cal.station.conditined.eqm, index.cal.station.conditined.gpqm, index.cal.station.conditined.gpqm2)
colnames(df) <- c("Obs","TRMM","PQM Cond", "EQM Cond", "GPQM Cond", "GPQM Cond (Theta2")
format(df, digits = 3, scientific = 5)
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```

# Ocean buoy?
```{r}
i=5


station.trmm <- subsetGrid(precip_trmm, station.id = precip_trmm$Metadata$station_id[i])
station.obs <- subsetGrid(precip_obs, station.id = precip_trmm$Metadata$station_id[i])
```

## PQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "pqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "pqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method ="pqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "pqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method ="pqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "pqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.pqm <- index.cal.station.conditioned
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```

```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.cal.conditioned$Data)],cal.station$Data[!is.na(cal.station$Data)],station.trmm$Data[!is.na(station.trmm$Data)]))))

abline(a = 0, b = 1)

points(station.obs$Data[!is.na(station.obs$Data)][order(station.obs$Data[!is.na(station.obs$Data)])], station.cal.conditioned$Data[!is.na(station.obs$Data)][order(station.cal.conditioned$Data[!is.na(station.obs$Data)])], col = "red", pch = 3, cex = .5)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("PQM-conditioned","PQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## EQM
```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "eqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "eqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "eqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "eqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "eqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "eqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.eqm <- index.cal.station.conditioned
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```

```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("EQM-conditioned","EQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## GPQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .95)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.gpqm <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```

```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.cal.conditioned$Data)],cal.station$Data[!is.na(cal.station$Data)],station.trmm$Data[!is.na(station.trmm$Data)]))))

abline(a = 0, b = 1)

points(station.obs$Data[!is.na(station.obs$Data)][order(station.obs$Data[!is.na(station.obs$Data)])], station.cal.conditioned$Data[!is.na(station.obs$Data)][order(station.cal.conditioned$Data[!is.na(station.obs$Data)])], col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```
## GPQM Theta = .7

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .7)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.gpqm2 <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station.conditined.pqm, index.cal.station.conditined.eqm, index.cal.station.conditined.gpqm, index.cal.station.conditined.gpqm2)
colnames(df) <- c("Obs","TRMM","PQM Cond", "EQM Cond", "GPQM Cond", "GPQM Cond (Theta2")
format(df, digits = 3, scientific = 5)
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(station.obs$Data[!is.na(station.obs$Data)][order(station.obs$Data[!is.na(station.obs$Data)])], station.cal.conditioned$Data[!is.na(station.obs$Data)][order(station.cal.conditioned$Data[!is.na(station.obs$Data)])], col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```

# Aoloau, American Samoa (high elevation)


```{r}
i=6


station.trmm <- subsetGrid(precip_trmm, station.id = precip_trmm$Metadata$station_id[i])
station.obs <- subsetGrid(precip_obs, station.id = precip_trmm$Metadata$station_id[i])
```

## PQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "pqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "pqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method ="pqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "pqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method ="pqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "pqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.pqm <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```

```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.cal.conditioned$Data)],cal.station$Data[!is.na(cal.station$Data)],station.trmm$Data[!is.na(station.trmm$Data)]))))

abline(a = 0, b = 1)

points(station.obs$Data[!is.na(station.obs$Data)][order(station.obs$Data[!is.na(station.obs$Data)])], station.cal.conditioned$Data[!is.na(station.obs$Data)][order(station.cal.conditioned$Data[!is.na(station.obs$Data)])], col = "red", pch = 3, cex = .5)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("PQM-conditioned","PQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## EQM
```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "eqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "eqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "eqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "eqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "eqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "eqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.eqm <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```

```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("EQM-conditioned","EQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## GPQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .95)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.gpqm <- index.cal.station.conditioned
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```

```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```
## GPQM theta = .7

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .7)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.gpqm2 <- index.cal.station.conditioned
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station.conditined.pqm, index.cal.station.conditined.eqm, index.cal.station.conditined.gpqm, index.cal.station.conditined.gpqm2)
colnames(df) <- c("Obs","TRMM","PQM Cond", "EQM Cond", "GPQM Cond", "GPQM Cond (Theta2")
format(df, digits = 3, scientific = 5)
```
```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```



# Aoloau, American Samoa (low elevation)
```{r}
i=7


station.trmm <- subsetGrid(precip_trmm, station.id = precip_trmm$Metadata$station_id[i])
station.obs <- subsetGrid(precip_obs, station.id = precip_trmm$Metadata$station_id[i])
```

## PQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "pqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "pqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method ="pqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "pqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method ="pqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "pqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.pqm <- index.cal.station.conditioned
```

```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```

```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.cal.conditioned$Data)],cal.station$Data[!is.na(cal.station$Data)],station.trmm$Data[!is.na(station.trmm$Data)]))))

abline(a = 0, b = 1)

points(station.obs$Data[!is.na(station.obs$Data)][order(station.obs$Data[!is.na(station.obs$Data)])], station.cal.conditioned$Data[!is.na(station.obs$Data)][order(station.cal.conditioned$Data[!is.na(station.obs$Data)])], col = "red", pch = 3, cex = .5)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("PQM-conditioned","PQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## EQM
```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "eqm")

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```


```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "eqm")

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "eqm")

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "eqm")

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "eqm")

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "eqm")

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.eqm <- index.cal.station.conditioned
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```

```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("EQM-conditioned","EQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid() 
```

## GPQM

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .95)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .95)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.gpqm <- index.cal.station.conditioned
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```

```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.cal.conditioned$Data)],cal.station$Data[!is.na(cal.station$Data)],station.trmm$Data[!is.na(station.trmm$Data)]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```

## GPQM theta = .7

```{r}
cal.station <- biasCorrection(y = station.obs, x = station.trmm, precipitation = TRUE,  method = "gpqm", theta = .7)

cal.station$Dates$start <- as.POSIXct(cal.station$Dates$start,tz = "GMT")
cal.station$Dates$end <- as.POSIXct(cal.station$Dates$end,tz = "GMT")
```

```{r}
station.obs.cl1 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 1))
station.trmm.cl1 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 1))

cal.station.cl1 <- biasCorrection(y = station.obs.cl1, x = station.trmm.cl1,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl1 <- which(!is.na(cal.station.cl1$Data))
cal.station.cl1$Data <- cal.station.cl1$Data[idx.cl1]
cal.station.cl1$Dates$start <- cal.station.cl1$Dates$start[idx.cl1]
cal.station.cl1$Dates$end <- cal.station.cl1$Dates$end[idx.cl1]


station.obs.cl2 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 2))
station.trmm.cl2 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 2))

cal.station.cl2 <- biasCorrection(y = station.obs.cl2, x = station.trmm.cl2,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl2 <- which(!is.na(cal.station.cl2$Data))
cal.station.cl2$Data <- cal.station.cl2$Data[idx.cl2]
cal.station.cl2$Dates$start <- cal.station.cl2$Dates$start[idx.cl2]
cal.station.cl2$Dates$end <- cal.station.cl2$Dates$end[idx.cl2]


station.obs.cl3 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 3))
station.trmm.cl3 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 3))

cal.station.cl3 <- biasCorrection(y = station.obs.cl3, x = station.trmm.cl3,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl3 <- which(!is.na(cal.station.cl3$Data))
cal.station.cl3$Data <- cal.station.cl3$Data[idx.cl3]
cal.station.cl3$Dates$start <- cal.station.cl3$Dates$start[idx.cl3]
cal.station.cl3$Dates$end <- cal.station.cl3$Dates$end[idx.cl3]


station.obs.cl4 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 4))
station.trmm.cl4 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 4))

cal.station.cl4 <- biasCorrection(y = station.obs.cl4, x = station.trmm.cl4,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl4 <- which(!is.na(cal.station.cl4$Data))
cal.station.cl4$Data <- cal.station.cl4$Data[idx.cl4]
cal.station.cl4$Dates$start <- cal.station.cl4$Dates$start[idx.cl4]
cal.station.cl4$Dates$end <- cal.station.cl4$Dates$end[idx.cl4]

station.obs.cl5 <- subsetDimension(station.obs, dimension = "time", indices = which(kmModel5$cluster == 5))
station.trmm.cl5 <- subsetDimension(station.trmm, dimension = "time", indices = which(kmModel5$cluster == 5))

cal.station.cl5 <- biasCorrection(y = station.obs.cl5, x = station.trmm.cl5,
                                  precipitation = TRUE,  method = "gpqm", theta = .7)

idx.cl5 <- which(!is.na(cal.station.cl5$Data))
cal.station.cl5$Data <- cal.station.cl5$Data[idx.cl5]
cal.station.cl5$Dates$start <- cal.station.cl5$Dates$start[idx.cl5]
cal.station.cl5$Dates$end <- cal.station.cl5$Dates$end[idx.cl5]


attr(cal.station.cl1$Data, 'dimensions') <- "time"
attr(cal.station.cl2$Data, 'dimensions') <- "time"
attr(cal.station.cl3$Data, 'dimensions') <- "time"
attr(cal.station.cl4$Data, 'dimensions') <- "time"
attr(cal.station.cl5$Data, 'dimensions') <- "time"

output.list <- list(cal.station.cl1, cal.station.cl2, cal.station.cl3,
                    cal.station.cl4,cal.station.cl5)


station.cal.conditioned <- redim(bindGrid(output.list, dimension = "time"), drop = TRUE)


```
```{r}
index.obs <- valueIndex1D(station.obs$Data[!is.na(station.obs$Data)],index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet"))
index.obs <- c(index.obs, valueIndex1D(station.obs$Data[!is.na(station.obs$Data)], index.codes = "P98WetAmount"))
index.obs.rv20max <- MaxReturnValue(station.obs)
index.obs <- c(index.obs, index.obs.rv20max)

index.trmm <- valueIndex1D(station.trmm$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))
index.trmm.rv20max <- MaxReturnValue(station.trmm)
index.trmm <- c(index.trmm, index.trmm.rv20max)


index.cal.station <- valueIndex1D(cal.station$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.rv20max <- MaxReturnValue(cal.station)

index.cal.station <- c(index.cal.station, index.cal.station.rv20max)

index.cal.station.conditioned <- valueIndex1D(station.cal.conditioned$Data,index.codes=c("Skewness","SDII","R10","R10p","R20","R20p","P98Wet","P98WetAmount"))


index.cal.station.conditioned.rv20max <- MaxReturnValue(station.cal.conditioned)

index.cal.station.conditioned <- c(index.cal.station.conditioned,
                                   index.cal.station.conditioned.rv20max)
index.cal.station.conditined.gpqm2 <- index.cal.station.conditioned
```


```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station, index.cal.station.conditioned)
colnames(df) <- c("Obs", "TRMM", "Cal", "Cal-Conditioned")
format(df, digits = 3, scientific = 5)
```
```{r}
diff.df <- data.frame(abs(index.trmm-index.obs),abs(index.cal.station-index.obs),
                      abs(index.cal.station.conditioned-index.obs)
                      )
colnames(diff.df) <- c("TRMM","Cal", "Cal-Conditioned")

format(diff.df, digits = 3, scientific = 5)
```

```{r}
diff.df <- data.frame(index.trmm-index.obs,index.cal.station-index.obs,
                      index.cal.station.conditioned-index.obs)
colnames(diff.df) <- c("TRMM","Cal", "Cal_Conditioned")

#options("scipen"=100, "digits"=4)

formattable(diff.df, list(
  'TRMM' = formatter("span", 
                         style = ~style(font.weight = "bold", color = 
                                          ifelse(TRMM > 0,"red",
                                                 ifelse(TRMM == 0,"black",
                                                        ifelse(TRMM <0, "blue",NA))))),
  'Cal' = formatter("span", 
                          style = ~style(font.weight = "bold", color = 
                                           ifelse(Cal > 0,"red",
                                                  ifelse(Cal == 0,"black",
                                                         ifelse(Cal <0, "blue",NA))))),
  
   'Cal_Conditioned' = formatter("span",
                          style = ~style(font.weight = "bold", color =
                                           ifelse(Cal_Conditioned > 0,"red",
                                                  ifelse(Cal_Conditioned == 0,"black",
                                                         ifelse(Cal_Conditioned < 0,"blue",NA)))))))
```
```{r}
df <- data.frame(index.obs, index.trmm, index.cal.station.conditined.pqm, index.cal.station.conditined.eqm, index.cal.station.conditined.gpqm, index.cal.station.conditined.gpqm2)
colnames(df) <- c("Obs","TRMM","PQM Cond", "EQM Cond", "GPQM Cond", "GPQM Cond (Theta2")
format(df, digits = 3, scientific = 5)
```


```{r}
qqplot(station.obs$Data[!is.na(station.obs$Data)], station.cal.conditioned$Data[!is.na(station.obs$Data)], main = paste(station.obs$Metadata$name), xlab = "Observed (mm)", ylab = "Predicted (mm)", col = "black", pch = 2, cex = .5,
       ylim =c(0,max(c(station.cal.conditioned$Data[!is.na(station.obs$Data)],cal.station$Data[!is.na(station.obs$Data)],station.trmm$Data[!is.na(station.obs$Data)][-1]))))

abline(a = 0, b = 1)

points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(cal.station$Data[!is.na(station.obs$Data)][-1]), col = "red", pch = 3, cex = .5)
points(sort(station.obs$Data[!is.na(station.obs$Data)]), sort(station.trmm$Data[!is.na(station.obs$Data)][-1]), col = "blue", pch = 4, cex = .5)

legend("topleft", legend = c("GPQM-conditioned","GPQM", "TRMM"), pch = c(2,3,4), col = c("black", "red","blue"))

grid()
```



